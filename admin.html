
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnix Admin Panel | অ্যাডমিন প্যানেল</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #4e73df;
            --secondary: #1cc88a;
            --dark: #2e59d9;
            --danger: #e74a3b;
            --warning: #f6c23e;
            --info: #36b9cc;
            --purple: #6f42c1;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        
        .login-card h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .login-card .form-control {
            margin-bottom: 20px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .login-card .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
        }
        
        .login-card .btn {
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo i {
            font-size: 50px;
            color: var(--primary);
            background: rgba(78, 115, 223, 0.1);
            padding: 20px;
            border-radius: 50%;
        }
        
        body {
            background-color: #f8f9fc;
            font-family: 'Segoe UI', 'Hind Siliguri', sans-serif;
            padding-top: 70px;
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 70px;
            left: -300px;
            width: 280px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(78, 115, 223, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .sidebar .nav-link i {
            width: 25px;
            text-align: center;
        }
        
        .sidebar .nav-badge {
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: auto;
        }
        
        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 998;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* Main Content */
        .main-content {
            padding: 20px;
            transition: margin-left 0.3s;
        }
        
        @media (min-width: 992px) {
            .sidebar {
                left: 0;
                width: 250px;
            }
            
            .main-content {
                margin-left: 250px;
            }
            
            .navbar-toggler {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
        }
        
        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .stat-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* Tables */
        .table-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        
        /* Method & Image items */
        .method-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .method-image, .image-preview {
            width: 40px; height: 40px;
            border-radius: 5px; object-fit: cover;
            border: 1px solid #ddd;
        }
        .image-preview { width: 80px; height: 80px; margin-top: 5px; }
        
        /* Screenshot preview */
        .screenshot-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: #f0f0f0;
        }
        
        .screenshot-preview:hover {
            transform: scale(1.5);
            z-index: 100;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Fee display */
        .fee-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Screenshot modal */
        .screenshot-modal-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Chat styles for admin panel */
        .chat-bubble-admin-panel {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .chat-bubble-admin-panel.user-msg {
            background-color: #e2f0ff;
            align-self: flex-start;
            margin-right: auto;
            align-items: flex-start;
        }
        .chat-bubble-admin-panel.admin-msg {
            background-color: #d4edda;
            align-self: flex-end;
            margin-left: auto;
            align-items: flex-end;
        }
        .chat-text-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chat-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 4px;
        }
        .delete-chat-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            opacity: 0.7;
            flex-shrink: 0;
        }
        .delete-chat-btn:hover {
            opacity: 1;
            color: #bd2130;
        }
        
        /* User info in navbar */
        .user-info {
            display: flex;
            align-items: center;
            color: white;
        }
        
        .user-info i {
            margin-right: 8px;
        }
        
        .user-info .logout-btn {
            margin-left: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .user-info .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        /* Hide main panel initially */
        .main-panel {
            display: none;
        }

        /* NEW: Content Section Styles */
        .content-section-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .content-section-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .content-section-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 5px 8px;
            font-size: 12px;
            z-index: 10;
        }
        .content-section-delete:hover {
            opacity: 0.8;
        }

        /* Plan Deposit Method Item (similar to general method-item but within plan modal) */
        .plan-method-item {
            background: #f0f8ff; /* Light blue background */
            border-left: 3px solid var(--info);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-method-item .method-info {
            display: flex;
            align-items: center;
        }
        .plan-method-item .method-image {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            object-fit: cover;
            border: 1px solid #cceeff;
            margin-right: 10px;
        }
        .plan-method-item .method-details {
            font-size: 14px;
        }
        .plan-method-item .method-details small {
            font-size: 12px;
            color: #666;
        }

        /* Popup Notice Buttons Style */
        .popup-button-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
        }
        .popup-button-item span {
            font-weight: 500;
        }
        .popup-button-item a {
            font-size: 0.85em;
            color: var(--primary);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-wallet"></i>
            </div>
            <h2>Earnix Admin Panel</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <input type="email" class="form-control" id="loginEmail" placeholder="অ্যাডমিন ইমেইল" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" id="loginPassword" placeholder="পাসওয়ার্ড" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>লগইন
                </button>
            </form>
            <div class="mt-3 text-center">
                <small class="text-muted">শুধুমাত্র অনুমোদিত অ্যাডমিন প্রবেশ করতে পারবে</small>
            </div>
        </div>
    </div>
    
    <!-- Main Admin Panel (Hidden Initially) -->
    <div id="mainPanel" class="main-panel">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                    <i class="fas fa-bars text-white"></i>
                </button>
                <a class="navbar-brand" href="#" onclick="showSection('dashboard')">
                    <i class="fas fa-wallet me-2"></i>Earnix এডমিন প্যানেল
                </a>
                <div class="d-flex align-items-center">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="loggedInUserEmail"></span>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>লগআউট
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar Menu -->
        <div class="sidebar" id="sidebar">
            <div class="pt-3">
                <div class="px-3 mb-4">
                    <h6 class="mb-0 text-dark">মেনুবার</h6>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt me-3"></i>ড্যাশবোর্ড
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('users')">
                        <i class="fas fa-users me-3"></i>ইউজার ম্যানেজমেন্ট
                        <span class="nav-badge bg-primary" id="totalUserCount">0</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('deposit-requests')">
                        <i class="fas fa-coins me-3"></i>ডিপোজিট রিকোয়েস্ট
                        <span class="nav-badge bg-danger" id="depositCountBadge">0</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('withdraw-requests')">
                        <i class="fas fa-money-bill-wave me-3"></i>উইথড্র রিকোয়েস্ট
                        <span class="nav-badge bg-danger" id="withdrawCountBadge">0</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('activation-requests')">
                        <i class="fas fa-user-check me-3"></i>একাউন্ট একটিভ রিকোয়েস্ট
                        <span class="nav-badge bg-danger" id="activationCountBadge">0</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('gmail-jobs')">
                        <i class="fab fa-google me-3"></i>জিমেইল জব রিকোয়েস্ট
                        <span class="nav-badge bg-danger" id="gmailJobCountBadge">0</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('plans')">
                        <i class="fas fa-crown me-3"></i>প্লান ম্যানেজমেন্ট
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('ref-challenges')">
                        <i class="fas fa-trophy me-3"></i>রেফারাল চ্যালেঞ্জ
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('gift-codes')">
                        <i class="fas fa-gift me-3"></i>গিফট কোড
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('settings')">
                        <i class="fas fa-cog me-3"></i>সেটিংস
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('admin-users')">
                        <i class="fas fa-user-shield me-3"></i>অ্যাডমিন ইউজার
                    </a>
                </nav>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section-content fade-in">
                <h4 class="mb-4 text-dark"><i class="fas fa-tachometer-alt me-2"></i>ড্যাশবোর্ড</h4>
                <div class="row">
                    <!-- Total Users -->
                    <div class="col-md-3">
                        <div class="stat-card bg-primary text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">মোট ইউজার</div>
                            <div class="stat-number text-white" id="totalUsers">0</div>
                        </div>
                    </div>
                    <!-- Pending Deposit -->
                    <div class="col-md-3">
                        <div class="stat-card bg-warning text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">পেন্ডিং ডিপোজিট</div>
                            <div class="stat-number text-white" id="totalPendingDeposits">0</div>
                        </div>
                    </div>
                    <!-- Pending Withdraw -->
                    <div class="col-md-3">
                        <div class="stat-card bg-danger text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">পেন্ডিং উইথড্র</div>
                            <div class="stat-number text-white" id="totalPendingWithdrawals">0</div>
                        </div>
                    </div>
                    <!-- Pending Activation -->
                    <div class="col-md-3">
                        <div class="stat-card bg-info text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">পেন্ডিং অ্যাক্টিভেশন</div>
                            <div class="stat-number text-white" id="totalPendingActivations">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <!-- Total Balance -->
                    <div class="col-md-3">
                        <div class="stat-card bg-success text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">মোট ব্যালেন্স</div>
                            <div class="stat-number text-white" id="totalBalance">0 ৳</div>
                        </div>
                    </div>
                    <!-- Total Withdraw -->
                    <div class="col-md-3">
                        <div class="stat-card bg-purple text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">মোট উত্তোলন</div>
                            <div class="stat-number text-white" id="totalWithdraw">0 ৳</div>
                        </div>
                    </div>
                    <!-- Total Income -->
                    <div class="col-md-3">
                        <div class="stat-card bg-dark text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">মোট আয়</div>
                            <div class="stat-number text-white" id="totalIncome">0 ৳</div>
                        </div>
                    </div>
                    <!-- Pending Gmail Jobs -->
                    <div class="col-md-3">
                        <div class="stat-card bg-secondary text-white" style="border-left-color: #fff;">
                            <div class="stat-title text-white-50">পেন্ডিং জিমেইল জব</div>
                            <div class="stat-number text-white" id="totalPendingGmailJobs">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>ড্যাশবোর্ড রিয়েল-টাইম ডাটা আপডেট করছে।
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fas fa-users me-2"></i>ইউজার ম্যানেজমেন্ট</h4>
                <div class="table-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>সকল ব্যবহারকারী</span>
                        <input type="text" class="form-control form-control-sm w-auto" placeholder="সার্চ..." onkeyup="searchUsers(this.value)">
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>নাম</th>
                                        <th>ব্যালেন্স</th>
                                        <th>প্লান</th>
                                        <th>স্ট্যাটাস</th>
                                        <th class="text-center">অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Requests (Deposit & Withdraw) -->
            <div id="deposit-requestsSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fas fa-coins me-2"></i>ডিপোজিট রিকোয়েস্ট</h4>
                <div class="table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ইউজার</th>
                                        <th>পরিমাণ</th>
                                        <th>মেথড</th>
                                        <th>ট্রানজেকশন ID</th>
                                        <th>সেন্ডার নাম্বার</th>
                                        <th>স্ক্রিনশট</th>
                                        <th>প্ল্যান</th>
                                        <th>তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="depositsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="withdraw-requestsSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fas fa-money-bill-wave me-2"></i>উইথড্র রিকোয়েস্ট</h4>
                <div class="table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ইউজার</th>
                                        <th>পরিমাণ</th>
                                        <th>ফি</th>
                                        <th>নেট</th>
                                        <th>মেথড</th>
                                        <th>নাম্বার</th>
                                        <th>তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawalsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activation Requests -->
            <div id="activation-requestsSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fas fa-user-check me-2"></i>একাউন্ট একটিভ রিকোয়েস্ট</h4>
                <div class="table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ইউজার</th>
                                        <th>পরিমাণ</th>
                                        <th>মেথড</th>
                                        <th>ট্রানজেকশন ID</th>
                                        <th>সেন্ডার নাম্বার</th>
                                        <th>স্ক্রিনশট</th>
                                        <th>তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="activationsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Job Requests (Gmail) -->
            <div id="gmail-jobsSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fab fa-google me-2"></i>জিমেইল জব রিকোয়েস্ট</h4>
                <div class="table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ইউজার</th>
                                        <th>ইমেইল</th>
                                        <th>রিওয়ার্ড</th>
                                        <th>তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="gmail_submissionsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plans Management Section -->
            <div id="plansSection" class="section-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-dark"><i class="fas fa-crown me-2"></i>প্লান ম্যানেজমেন্ট</h4>
                    <button class="btn btn-success" onclick="showAddPlanModal()">
                        <i class="fas fa-plus me-2"></i>নতুন প্লান
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="table-card">
                            <div class="card-header">সকল প্লান</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>নাম</th>
                                                <th>মূল্য</th>
                                                <th>টাস্ক</th>
                                                <th>দৈনিক আয়</th>
                                                <th>স্ট্যাটাস</th>
                                                <th>অ্যাকশন</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plansTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="table-card">
                            <div class="card-header">
                                <i class="fas fa-tasks me-2"></i>প্লান অনুযায়ী টাস্ক সেট
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <select class="form-select w-50" id="planForTasks" onchange="loadPlanTasks(this.value)">
                                        <option value="">প্লান নির্বাচন করুন</option>
                                        <option value="basic">ফ্রি টাস্ক (Basic)</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="showAddTaskToPlanModal()" id="addTaskBtn" disabled>
                                        <i class="fas fa-plus me-2"></i>নতুন টাস্ক
                                    </button>
                                </div>
                                
                                <div id="planTasksContainer" style="display: none;">
                                    <div class="table-responsive mt-3">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>টাস্ক নাম</th>
                                                    <th>রিওয়ার্ড</th>
                                                    <th>লিমিট</th>
                                                    <th>স্ট্যাটাস</th>
                                                    <th>অ্যাকশন</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planTasksTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Challenges Section -->
            <div id="ref-challengesSection" class="section-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-dark"><i class="fas fa-trophy me-2"></i>রেফারাল চ্যালেঞ্জ ম্যানেজমেন্ট</h4>
                    <button class="btn btn-success" onclick="showAddRefChallengeModal()">
                        <i class="fas fa-plus me-2"></i>নতুন চ্যালেঞ্জ
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-card">
                            <div class="card-header">সকল রেফারাল চ্যালেঞ্জ</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>টার্গেট (Active Refs)</th>
                                                <th>পুরস্কার (৳)</th>
                                                <th>স্ট্যাটাস</th>
                                                <th>অ্যাকশন</th>
                                            </tr>
                                        </thead>
                                        <tbody id="refChallengesTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>ইনস্ট্রাকশন</h5>
                            <p class="mb-1">• "টার্গেট" হল ইউজারকে কতটি Active Referral থাকতে হবে</p>
                            <p class="mb-1">• "পুরস্কার" হল ইউজার কত টাকা পাবে</p>
                            <p class="mb-0">• প্রতিটি চ্যালেঞ্জ Daily Basis তে Claimable</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>নোট</h5>
                            <p class="mb-0">এই চ্যালেঞ্জগুলি ইউজার প্যানেলের "Referral Challenge" সেকশনে দেখানো হবে। ইউজাররা প্রতিদিন একবার করে Claim করতে পারবে।</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gift Codes Section (NEW) -->
            <div id="gift-codesSection" class="section-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-dark"><i class="fas fa-gift me-2"></i>গিফট কোড ম্যানেজমেন্ট</h4>
                    <button class="btn btn-success" onclick="showGenerateGiftCodeModal()">
                        <i class="fas fa-plus me-2"></i>নতুন গিফট কোড
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-card">
                            <div class="card-header">সকল গিফট কোড</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>কোড</th>
                                                <th>পরিমাণ (৳)</th>
                                                <th>ব্যবহার সংখ্যা</th>
                                                <th>সর্বোচ্চ ব্যবহার</th>
                                                <th>মেয়াদোত্তীর্ণের তারিখ</th>
                                                <th>স্ট্যাটাস</th>
                                                <th>অ্যাকশন</th>
                                            </tr>
                                        </thead>
                                        <tbody id="giftCodesTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="section-content" style="display: none;">
                <h4 class="mb-4 text-dark"><i class="fas fa-cog me-2"></i>সিস্টেম সেটিংস</h4>
                <ul class="nav nav-tabs" id="settingsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees" type="button">ফি ও লিমিট</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="job-settings-tab" data-bs-toggle="tab" data-bs-target="#job-settings" type="button">জব সেটিংস</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="methods-tab" data-bs-toggle="tab" data-bs-target="#methods" type="button">ডিপোজিট ও উইথড্র মেথড</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="controls-tab" data-bs-toggle="tab" data-bs-target="#controls" type="button">গ্লোবাল কন্ট্রোল</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notice-tab" data-bs-toggle="tab" data-bs-target="#notice" type="button">নোটিশ ও সাপোর্ট</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="popup-notice-tab" data-bs-toggle="tab" data-bs-target="#popup-notice" type="button">পপ-আপ নোটিশ</button> <!-- NEW TAB -->
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="content-settings-tab" data-bs-toggle="tab" data-bs-target="#content-settings" type="button">কন্টেন্ট ও টাস্ক সেটিংস</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="app-appearance-tab" data-bs-toggle="tab" data-bs-target="#app-appearance" type="button">অ্যাপ অ্যাপিয়ারেন্স</button>
                    </li>
                </ul>
                
                <div class="tab-content mt-4">
                    <!-- Fees & Limits Tab -->
                    <div class="tab-pane fade show active" id="fees" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">ফি ও লিমিট সেটআপ</div>
                                    <div class="card-body">
                                        <form id="feesSettingsForm">
                                            <div class="mb-3">
                                                <label class="form-label">একাউন্ট একটিভ ফি (৳)</label>
                                                <input type="number" class="form-control" id="activationFee" value="100">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">মিনিমাম উইথড্র (৳)</label>
                                                <input type="number" class="form-control" id="minWithdraw" value="100">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">মিনিমাম ডিপোজিট (৳)</label>
                                                <input type="number" class="form-control" id="minDeposit" value="50">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">রেফার বোনাস (৳)</label>
                                                <input type="number" class="form-control" id="referrerBonus" value="20">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">উইথড্র ফি (%)</label>
                                                <input type="number" class="form-control" id="withdrawFee" value="5" step="0.1">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">উইথড্র করতে রেফার প্রয়োজন</label>
                                                <input type="number" class="form-control" id="withdrawReqRefs" value="0">
                                            </div>
                                            <button type="button" class="btn btn-success w-100" onclick="saveFeesSettings()">
                                                <i class="fas fa-save me-2"></i>সেটিংস সেভ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Settings Tab -->
                    <div class="tab-pane fade" id="job-settings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">জিমেইল জব সেটিংস</div>
                                    <div class="card-body">
                                        <form id="gmailJobSettingsForm">
                                            <div class="mb-3">
                                                <label class="form-label">জিমেইল জব রিওয়ার্ড (৳)</label>
                                                <input type="number" class="form-control" id="gmailJobReward" value="10">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">জিমেইল পাসওয়ার্ড</label>
                                                <input type="text" class="form-control" id="gmailPassword" value="password123">
                                            </div>
                                            <button type="button" class="btn btn-success w-100" onclick="saveGmailJobSettings()">
                                                <i class="fas fa-save me-2"></i>সেটিংস সেভ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Methods Tab -->
                    <div class="tab-pane fade" id="methods" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">ডিপোজিট মেথড যোগ করুন</div>
                                    <div class="card-body">
                                        <form id="addDepositMethodForm">
                                            <div class="mb-3">
                                                <label class="form-label">নাম *</label>
                                                <input type="text" class="form-control" id="depositMethodName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ইমেজ লিংক *</label>
                                                <input type="url" class="form-control" id="depositMethodImage" onchange="previewImage(this.value, 'depositPreview')" required>
                                                <div id="depositPreview" class="mt-2"></div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ডিপোজিট নাম্বার *</label>
                                                <input type="text" class="form-control" id="depositMethodNumber" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">গেটওয়ে লিংক (ঐচ্ছিক)</label>
                                                <input type="url" class="form-control" id="depositMethodGatewayLink" placeholder="যদি কোনো গেটওয়ে থাকে">
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-plus me-2"></i>মেথড যোগ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div class="table-card mt-3">
                                    <div class="card-header">ডিপোজিট মেথড তালিকা</div>
                                    <div class="card-body" id="depositMethodsList"></div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">উইথড্র মেথড যোগ করুন</div>
                                    <div class="card-body">
                                        <form id="addWithdrawMethodForm">
                                            <div class="mb-3">
                                                <label class="form-label">নাম *</label>
                                                <input type="text" class="form-control" id="withdrawMethodName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ইমেজ লিংক *</label>
                                                <input type="url" class="form-control" id="withdrawMethodImage" onchange="previewImage(this.value, 'withdrawPreview')" required>
                                                <div id="withdrawPreview" class="mt-2"></div>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-plus me-2"></i>মেথড যোগ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div class="table-card mt-3">
                                    <div class="card-header">উইথড্র মেথড তালিকা</div>
                                    <div class="card-body" id="withdrawMethodsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Controls Tab -->
                    <div class="tab-pane fade" id="controls" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">সিস্টেম কন্ট্রোল (অন/অফ)</div>
                                    <div class="card-body">
                                        <div class="mb-3 d-flex justify-content-between align-items-center">
                                            <span>উইথড্র সিস্টেম</span>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="toggleWithdraw" checked>
                                            </div>
                                        </div>
                                        <div class="mb-3 d-flex justify-content-between align-items-center">
                                            <span>ডিপোজিট সিস্টেম</span>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="toggleDeposit" checked>
                                            </div>
                                        </div>
                                        <div class="mb-3 d-flex justify-content-between align-items-center">
                                            <span>জিমেইল জব সিস্টেম</span>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="toggleGmailJob" checked>
                                            </div>
                                        </div>
                                        <div class="mb-3 d-flex justify-content-between align-items-center">
                                            <span>রেফারেল সিস্টেম</span>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="toggleReferral" checked>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">ডেইলি লগইন বোনাস (৳)</label>
                                            <input type="number" class="form-control" id="dailyLoginBonus" value="2">
                                        </div>
                                        <button type="button" class="btn btn-primary w-100 mt-3" onclick="saveSystemToggles()">
                                            <i class="fas fa-save me-2"></i>টগল সেভ করুন
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notice and Support Tab -->
                    <div class="tab-pane fade" id="notice" role="tabpanel">
                         <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">ইউজার প্যানেলে নোটিশ পাঠান (স্ক্রলিং নোটিশ)</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">নোটিশ টাইটেল</label>
                                            <input type="text" class="form-control" id="userNoticeTitle" placeholder="Notice">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">নোটিশ মেসেজ</label>
                                            <textarea class="form-control" id="userNotice" rows="3"></textarea>
                                        </div>
                                        <button type="button" class="btn btn-warning w-100" onclick="sendUserNotice()">
                                            <i class="fas fa-paper-plane me-2"></i>নোটিশ পাঠান
                                        </button>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">সোশ্যাল সাপোর্ট লিংক সেটআপ</div>
                                    <div class="card-body">
                                        <form id="addSupportLinkForm">
                                            <div class="mb-3">
                                                <label class="form-label">নাম * (যেমন: Telegram)</label>
                                                <input type="text" class="form-control" id="supportLinkName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">লিংক *</label>
                                                <input type="url" class="form-control" id="supportLinkUrl" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">আইকন ক্লাস (যেমন: fab fa-telegram) *</label>
                                                <input type="text" class="form-control" id="supportLinkIcon" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-plus me-2"></i>লিংক যোগ করুন
                                            </button>
                                        </form>
                                        <hr>
                                        <h6>বর্তমান লিংকসমূহ</h6>
                                        <div id="supportLinksList" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Popup Notice Tab -->
                    <div class="tab-pane fade" id="popup-notice" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="table-card">
                                    <div class="card-header">ইউজার প্যানেলে পপ-আপ নোটিশ সেট করুন</div>
                                    <div class="card-body">
                                        <form id="popupNoticeForm">
                                            <div class="mb-3">
                                                <label class="form-label">নোটিশ টাইটেল</label>
                                                <input type="text" class="form-control" id="popupNoticeTitle" placeholder="যেমন: জরুরি ঘোষণা!">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">নোটিশ মেসেজ</label>
                                                <textarea class="form-control" id="popupNoticeMessage" rows="4" placeholder="আপনার বার্তা এখানে লিখুন..."></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ইমেজ লিংক (ঐচ্ছিক)</label>
                                                <input type="url" class="form-control" id="popupNoticeImageLink" onchange="previewImage(this.value, 'popupNoticeImagePreview')" placeholder="ইমেজের URL দিন">
                                                <div id="popupNoticeImagePreview" class="mt-2"></div>
                                            </div>
                                            <div class="form-check form-switch mb-4">
                                                <input class="form-check-input" type="checkbox" id="popupNoticeActive" checked>
                                                <label class="form-check-label" for="popupNoticeActive">পপ-আপ সক্রিয় রাখুন</label>
                                            </div>
                                            <hr>
                                            <h6 class="mb-3">ইনলাইন বাটন যোগ করুন</h6>
                                            <div class="mb-3 d-flex gap-2">
                                                <input type="text" class="form-control" id="newPopupButtonText" placeholder="বাটনের লেখা (যেমন: Telegram)">
                                                <select class="form-select flex-grow-1" id="newPopupButtonLinkSelect">
                                                    <option value="">লিংক নির্বাচন করুন বা টাইপ করুন</option>
                                                </select>
                                                <input type="url" class="form-control flex-grow-1" id="newPopupButtonCustomLink" placeholder="কাস্টম লিংক দিন" style="display: none;">
                                                <button type="button" class="btn btn-info btn-sm" onclick="toggleCustomLinkInput()"><i class="fas fa-link"></i></button>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="addPopupNoticeButton()"><i class="fas fa-plus"></i></button>
                                            </div>
                                            <div id="popupNoticeButtonsList" class="mb-4">
                                                <!-- Dynamic buttons will be loaded here -->
                                            </div>

                                            <button type="button" class="btn btn-success w-100" onclick="savePopupNoticeSettings()">
                                                <i class="fas fa-save me-2"></i>পপ-আপ নোটিশ সেভ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content & Task Settings Tab -->
                    <div class="tab-pane fade" id="content-settings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="table-card">
                                    <div class="card-header">টাস্ক অপেক্ষা সময় সেটআপ</div>
                                    <div class="card-body">
                                        <form id="taskWaitSettingsForm">
                                            <div class="mb-3">
                                                <label class="form-label">টাস্ক অপেক্ষা সময় (সেকেন্ড) *</label>
                                                <input type="number" class="form-control" id="taskWaitTime" min="1" value="10" required>
                                                <div class="form-text">ইউজার প্যানেলের টাস্ক করার সময় কত সেকেন্ড অপেক্ষা করতে হবে।</div>
                                            </div>
                                            <button type="button" class="btn btn-success w-100" onclick="saveContentSettings()">
                                                <i class="fas fa-save me-2"></i>সেটিংস সেভ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="table-card mt-3">
                                    <div class="card-header">প্রাইভেসি পলিসি কন্টেন্ট <span class="badge bg-secondary">আনলিমিটেড</span></div>
                                    <div class="card-body">
                                        <div id="privacyPolicySectionsContainer" class="mb-3 space-y-3">
                                            <!-- Dynamic sections will be rendered here -->
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('privacyPolicy', 'text')"><i class="fas fa-plus me-1"></i> Add Text</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('privacyPolicy', 'image')"><i class="fas fa-image me-1"></i> Add Image</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('privacyPolicy', 'video')"><i class="fas fa-video me-1"></i> Add Video</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('privacyPolicy', 'title')"><i class="fas fa-heading me-1"></i> Add Title</button>
                                        </div>
                                        <button type="button" class="btn btn-success w-100" onclick="saveContentSettings()"><i class="fas fa-save me-2"></i>সেভ করুন</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="table-card mt-3">
                                    <div class="card-header">রুলস (Rules) পেজ কন্টেন্ট <span class="badge bg-secondary">আনলিমিটেড</span></div>
                                    <div class="card-body">
                                        <div id="rulesSectionsContainer" class="mb-3 space-y-3">
                                            <!-- Dynamic sections will be rendered here -->
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('rules', 'text')"><i class="fas fa-plus me-1"></i> Add Text</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('rules', 'image')"><i class="fas fa-image me-1"></i> Add Image</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('rules', 'video')"><i class="fas fa-video me-1"></i> Add Video</button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="addContentSection('rules', 'title')"><i class="fas fa-heading me-1"></i> Add Title</button>
                                        </div>
                                        <button type="button" class="btn btn-success w-100" onclick="saveContentSettings()"><i class="fas fa-save me-2"></i>সেভ করুন</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- App Appearance Tab (NEW) -->
                    <div class="tab-pane fade" id="app-appearance" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-card">
                                    <div class="card-header">অ্যাপের নাম ও লোগো</div>
                                    <div class="card-body">
                                        <form id="appAppearanceForm">
                                            <div class="mb-3">
                                                <label class="form-label">অ্যাপের নাম (ইউজার প্যানেলে)</label>
                                                <input type="text" class="form-control" id="appName" placeholder="যেমন: Earnix">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">অ্যাপ লোগো URL (ইউজার প্যানেলে)</label>
                                                <input type="url" class="form-control" id="appLogoURL" onchange="previewImage(this.value, 'appLogoPreview')" placeholder="লোগোর URL দিন">
                                                <div id="appLogoPreview" class="mt-2"></div>
                                            </div>
                                            <button type="button" class="btn btn-success w-100" onclick="saveAppAppearanceSettings()">
                                                <i class="fas fa-save me-2"></i>সেভ করুন
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Users Section -->
            <div id="admin-usersSection" class="section-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-dark"><i class="fas fa-user-shield me-2"></i>অ্যাডমিন ইউজার ম্যানেজমেন্ট</h4>
                    <button class="btn btn-success" onclick="showAddAdminModal()">
                        <i class="fas fa-plus me-2"></i>নতুন অ্যাডমিন
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="table-card">
                            <div class="card-header">অ্যাডমিন ইউজার তালিকা</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>ইমেইল</th>
                                                <th>নাম</th>
                                                <th>রোল</th>
                                                <th>তৈরির তারিখ</th>
                                                <th>অ্যাকশন</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminUsersTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="table-card">
                            <div class="card-header">ইনস্ট্রাকশন</div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>অ্যাডমিন ইউজার তৈরি</h6>
                                    <p class="mb-2">• নতুন অ্যাডমিন ইউজার যোগ করতে উপরের "নতুন অ্যাডমিন" বাটনে ক্লিক করুন</p>
                                    <p class="mb-2">• প্রতিটি অ্যাডমিনের জন্য ইউনিক ইমেইল দিন</p>
                                    <p class="mb-2">• পাসওয়ার্ড কমপক্ষে ৬ ক্যারেক্টারের হতে হবে</p>
                                    <p class="mb-0">• সাব-অ্যাডমিন শুধু ড্যাশবোর্ড দেখতে পারবে</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- User Edit Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ব্যবহারকারী এডিট করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">নাম</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ব্যালেন্স (৳)</label>
                            <input type="number" class="form-control" id="editUserBalance" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">প্লান</label>
                            <select class="form-select" id="editUserPlan"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">অ্যাকাউন্ট স্ট্যাটাস</label>
                            <select class="form-select" id="editUserActiveStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">প্ল্যান এক্সপায়ার ডেট</label>
                            <input type="date" class="form-control" id="editPlanExpirationDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">সেভ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ref Challenge Modal -->
    <div class="modal fade" id="refChallengeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="refChallengeModalTitle">নতুন রেফারাল চ্যালেঞ্জ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="refChallengeForm">
                        <input type="hidden" id="refChallengeId">
                        <div class="mb-3">
                            <label class="form-label">টার্গেট (Active Referrals) *</label>
                            <input type="number" class="form-control" id="refChallengeTarget" min="1" required>
                            <div class="form-text">কতটি Active Referral থাকতে হবে</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">পুরস্কার (৳) *</label>
                            <input type="number" class="form-control" id="refChallengeReward" min="1" required>
                            <div class="form-text">ইউজার কত টাকা পাবে</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">স্ট্যাটাস</label>
                            <select class="form-select" id="refChallengeStatus">
                                <option value="active">সক্রিয়</option>
                                <option value="inactive">নিষ্ক্রিয়</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-success" onclick="saveRefChallenge()">সেভ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin User Modal -->
    <div class="modal fade" id="adminUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="adminUserModalTitle">নতুন অ্যাডমিন ইউজার</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adminUserForm">
                        <input type="hidden" id="adminUserId">
                        <div class="mb-3">
                            <label class="form-label">ইমেইল *</label>
                            <input type="email" class="form-control" id="adminUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">নাম *</label>
                            <input type="text" class="form-control" id="adminUserName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">পাসওয়ার্ড *</label>
                            <input type="password" class="form-control" id="adminUserPassword" minlength="6" required>
                            <div class="form-text">পাসওয়ার্ড কমপক্ষে ৬ ক্যারেক্টারের হতে হবে</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">কনফার্ম পাসওয়ার্ড *</label>
                            <input type="password" class="form-control" id="adminUserConfirmPassword" minlength="6" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">রোল</label>
                            <select class="form-select" id="adminUserRole">
                                <option value="super_admin">সুপার অ্যাডমিন</option>
                                <option value="admin">অ্যাডমিন</option>
                                <option value="sub_admin">সাব-অ্যাডমিন</option>
                            </select>
                            <div class="form-text">সাব-অ্যাডমিন শুধু ড্যাশবোর্ড দেখতে পারবে</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-primary" onclick="saveAdminUser()">সেভ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div class="modal fade" id="planModal" tabindex="-1">
        <div class="modal-dialog modal-lg"> <!-- Increased size for deposit methods -->
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="planModalTitle">নতুন প্লান তৈরি করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="planId">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">প্লানের বিবরণ</h6>
                                <div class="mb-3">
                                    <label class="form-label">প্লান নাম *</label>
                                    <input type="text" class="form-control" id="planName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">প্লান মূল্য (৳) *</label>
                                    <input type="number" class="form-control" id="planPrice" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ডেইলি টাস্ক (সংখ্যা) *</label>
                                    <input type="number" class="form-control" id="planDailyTasks" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">দৈনিক আয় (৳) *</label>
                                    <input type="number" class="form-control" id="planDailyEarning" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ভ্যালিডিটি (দিন) *</label>
                                    <input type="number" class="form-control" id="planValidity" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">স্ট্যাটাস</label>
                                    <select class="form-select" id="planStatus">
                                        <option value="active">সক্রিয়</option>
                                        <option value="inactive">নিষ্ক্রিয়</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">প্লান ডিপোজিট মেথড সেটআপ</h6>
                                <div class="alert alert-info py-2 small">
                                    এই প্লানের জন্য নির্দিষ্ট ডিপোজিট মেথড যোগ করুন। যদি এখানে কোনো মেথড না থাকে, তাহলে গ্লোবাল মেথড ব্যবহার করা হবে।
                                </div>
                                <div id="planDepositMethodsContainer" class="mb-3">
                                    <label class="form-label d-block">ডিপোজিট মেথড তালিকা</label>
                                    <div id="planDepositMethodsList">
                                        <!-- Plan specific methods will be rendered here -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="addPlanDepositMethod()">
                                        <i class="fas fa-plus me-1"></i> নতুন মেথড যোগ করুন
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-success" id="planModalSaveBtn" onclick="savePlan()">প্লান তৈরি করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="taskModalTitle">নতুন টাস্ক যোগ করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <input type="hidden" id="taskPlanId">
                        <div class="mb-3">
                            <label class="form-label">টাস্ক নাম *</label>
                            <input type="text" class="form-control" id="taskName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">টাস্ক লিংক *</label>
                            <input type="url" class="form-control" id="taskLink" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">রিওয়ার্ড (৳) *</label>
                            <input type="number" class="form-control" id="taskReward" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ডেইলি লিমিট (ইউজার প্রতি) *</label>
                            <input type="number" class="form-control" id="taskDailyLimit" value="1" min="0" required>
                            <div class="form-text">
                                <p class="mb-0">১ = প্রতিদিন ১ বার (One-Time Daily)</p>
                                <p class="mb-0">২+ = প্রতিদিন যতবার চান (Multiple Times Daily)</p>
                                <p class="mb-0">০ = আনলিমিটেড (Unlimited Daily)</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">স্ট্যাটাস</label>
                            <select class="form-select" id="taskStatus">
                                <option value="active">সক্রিয়</option>
                                <option value="inactive">নিষ্ক্রিয়</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-primary" id="taskModalSaveBtn" onclick="saveTask()">টাস্ক যোগ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Action Modal -->
    <div class="modal fade" id="requestActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="actionModalTitle">অনুরোধ প্রক্রিয়া করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="actionReqId">
                    <input type="hidden" id="actionReqType">
                    <input type="hidden" id="actionUserId">
                    <input type="hidden" id="actionAmount">
                    <input type="hidden" id="actionPlanName">
                    <input type="hidden" id="actionTransactionId"> 
                    <p class="mb-2"><strong>ইউজার:</strong> <span id="actionUserName" class="fw-bold"></span></p>
                    <p class="mb-2"><strong>পরিমাণ:</strong> <span id="actionAmountDisplay" class="fw-bold text-danger"></span></p>
                    <p class="mb-4"><strong>ট্রানজেকশন/মেথড:</strong> <span id="actionTrxDetails"></span></p>
                    <div class="mb-3">
                        <label class="form-label">মেসেজ (ঐচ্ছিক)</label>
                        <textarea class="form-control" id="actionMessage" rows="3" placeholder="ইউজারকে মেসেজ দিন..."></textarea>
                    </div>
                    <p class="text-danger small" id="job-warning" style="display: none;">**জব এপ্রুভ করলে ইউজারের ব্যালেন্সে সরাসরি রিওয়ার্ড যোগ হবে।</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-danger" onclick="processRequest('rejected')">রিজেক্ট করুন</button>
                    <button type="button" class="btn btn-success" onclick="processRequest('approved')">অনুমোদন করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Support Link Modal -->
    <div class="modal fade" id="editSupportLinkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">সাপোর্ট লিংক এডিট করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSupportLinkForm">
                        <input type="hidden" id="editSupportLinkId">
                        <div class="mb-3">
                            <label class="form-label">নাম *</label>
                            <input type="text" class="form-control" id="editSupportLinkName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">লিংক *</label>
                            <input type="url" class="form-control" id="editSupportLinkUrl" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">আইকন ক্লাস *</label>
                            <input type="text" class="form-control" id="editSupportLinkIcon" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-primary" onclick="updateSupportLink()">সেভ করুন</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Screenshot View Modal -->
    <div class="modal fade" id="screenshotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">স্ক্রিনশট দেখুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="screenshotImage" class="screenshot-modal-img" src="" alt="Screenshot">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বন্ধ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="viewUserChatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ইউজারের সাথে চ্যাট করুন (<span id="chatUserNameTitle"></span>)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column" style="max-height: 70vh;">
                    <div id="userChatMessages" class="flex-grow-1 overflow-auto p-3 bg-light mb-3 rounded" style="display: flex; flex-direction: column; min-height: 200px;">
                        <!-- Chat messages will be loaded here -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="adminChatMessageInput" class="form-control" placeholder="মেসেজ লিখুন...">
                        <button class="btn btn-primary" type="button" id="sendAdminChatMessageBtn">পাঠান</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Code Modal (NEW) -->
    <div class="modal fade" id="giftCodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="giftCodeModalTitle">নতুন গিফট কোড তৈরি করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="giftCodeForm">
                        <div class="mb-3">
                            <label class="form-label">কোড (ঐচ্ছিক, খালি রাখলে অটো জেনারেট হবে)</label>
                            <input type="text" class="form-control" id="giftCodeCode" placeholder="যেমন: FREEBONUS200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">পরিমাণ (৳) *</label>
                            <input type="number" class="form-control" id="giftCodeAmount" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">সর্বোচ্চ ব্যবহার * (এই কোড কতজন ব্যবহার করতে পারবে)</label>
                            <input type="number" class="form-control" id="giftCodeMaxUsage" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">মেয়াদোত্তীর্ণের তারিখ *</label>
                            <input type="date" class="form-control" id="giftCodeExpiry" required>
                            <div class="form-text">এই তারিখের পর কোড কাজ করবে না।</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-success" onclick="generateAndSaveGiftCode()">গিফট কোড তৈরি করুন</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Plan Deposit Method Modal (Used for adding/editing a single method within the plan modal) -->
    <div class="modal fade" id="planDepositMethodEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="planDepositMethodEditModalTitle">প্লান ডিপোজিট মেথড যোগ করুন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planDepositMethodForm">
                        <input type="hidden" id="planDepositMethodKey">
                        <div class="mb-3">
                            <label class="form-label">নাম *</label>
                            <input type="text" class="form-control" id="planDepositMethodName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ইমেজ লিংক *</label>
                            <input type="url" class="form-control" id="planDepositMethodImage" onchange="previewImage(this.value, 'planDepositMethodPreview')" required>
                            <div id="planDepositMethodPreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ডিপোজিট নাম্বার *</label>
                            <input type="text" class="form-control" id="planDepositMethodNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">গেটওয়ে লিংক (ঐচ্ছিক)</label>
                            <input type="url" class="form-control" id="planDepositMethodGatewayLink" placeholder="যদি কোনো গেটওয়ে থাকে">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-info" onclick="savePlanDepositMethod()">সেভ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
  apiKey: "AIzaSyBsLraW-VGSZuDaqYWzrrBBlaWYWOat2t8",
  authDomain: "sponsor-job.firebaseapp.com",
  databaseURL: "https://sponsor-job-default-rtdb.firebaseio.com",
  projectId: "sponsor-job",
  storageBucket: "sponsor-job.firebasestorage.app",
  messagingSenderId: "476816277996",
  appId: "1:476816277996:web:32bd3e0c21e467e24180c9",
};
  
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // References
        const usersRef = database.ref('users');
        const adminUsersRef = database.ref('adminUsers');
        const depositsRef = database.ref('deposits');
        const withdrawalsRef = database.ref('withdrawals');
        const activationsRef = database.ref('activations');
        const gmailSubmissionsRef = database.ref('gmail_submissions');
        const plansRef = database.ref('settings/plans');
        const tasksRef = database.ref('settings/tasks');
        const settingsRef = database.ref('settings/app'); // Main app settings
        const contentSettingsRef = database.ref('settings/content'); 
        const gmailSettingsRef = database.ref('settings/gmail');
        const depositMethodsRef = database.ref('settings/depositMethods'); // Global deposit methods
        const withdrawMethodsRef = database.ref('settings/withdrawMethods');
        const supportLinksRef = database.ref('settings/supportSocialLinks');
        const transactionsRef = database.ref('transactions');
        const refChallengesRef = database.ref('settings/refChallenges');
        const giftCodesRef = database.ref('giftCodes'); // NEW: Gift Codes Reference
        const adminPopupRef = database.ref('settings/adminPopup'); // NEW: Admin Popup Notice

        let currentPlanId = null;
        let currentPlanDepositMethods = {}; // To store methods for the plan being edited
        let currentChatUserId = null;
        let userChatMessagesListener = null;
        let currentAdminRole = null;
        let popupNoticeButtons = []; // For managing buttons in the popup notice tab

        // --- ENCRYPTION CONFIGURATION (MUST MATCH USER APP) ---
        const ENCRYPTION_KEY = "EarningAppSecureKey2024!@#"; 
        
        const decryptData = (encryptedData) => {
            try {
                if (!encryptedData || typeof encryptedData !== 'string') {
                    console.warn("Attempted to decrypt invalid data:", encryptedData);
                    return '';
                }
                const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedString) {
                    console.error("Decryption resulted in empty string. Possibly wrong key or corrupted data.");
                    return '';
                }
                return decryptedString;
            } catch (error) {
                console.error("Decryption error:", error);
                return ''; 
            }
        };

        // --- LOGIN SYSTEM FUNCTIONS ---
        function checkLoginStatus() {
            const loggedIn = localStorage.getItem('adminLoggedIn');
            const userEmail = localStorage.getItem('adminEmail');
            const userRole = localStorage.getItem('adminRole');
            
            if (loggedIn === 'true' && userEmail) {
                currentAdminRole = userRole;
                showMainPanel(userEmail);
                updateNavbarUserInfo(userEmail);
                
                // Check if this is the first time (no admin users in database)
                checkAndCreateDefaultAdmin();
            } else {
                showLoginPage();
            }
        }
        
        function checkAndCreateDefaultAdmin() {
            adminUsersRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    // Create default admin user if none exists
                    const defaultAdmin = {
                        email: "admin@earnix.com", // Changed default admin email
                        password: "admin123",
                        name: "Super Admin",
                        role: "super_admin",
                        createdAt: Date.now()
                    };
                    adminUsersRef.push().set(defaultAdmin)
                    .then(() => {
                        console.log("Default admin user created");
                    })
                    .catch(error => {
                        console.error("Error creating default admin:", error);
                    });
                }
            });
        }
        
        function showLoginPage() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('mainPanel').style.display = 'none';
        }
        
        function showMainPanel(email) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            showSection('dashboard');
        }
        
        function updateNavbarUserInfo(email) {
            document.getElementById('loggedInUserEmail').textContent = email;
        }
        
        function logout() {
            const result = confirm("আপনি কি নিশ্চিত লগআউট করতে চান?");
            if (result) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminEmail');
                localStorage.removeItem('adminRole');
                currentAdminRole = null;
                showLoginPage();
                Swal.fire('লগআউট', 'আপনি সফলভাবে লগআউট করেছেন।', 'success');
            }
        }
        
        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                Swal.fire('ত্রুটি!', 'দয়া করে ইমেইল ও পাসওয়ার্ড দিন', 'error');
                return;
            }
            
            try {
                // Show loading
                Swal.fire({
                    title: 'লগইন হচ্ছে...',
                    text: 'অনুগ্রহ করে অপেক্ষা করুন',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Check admin credentials from Firebase
                const snapshot = await adminUsersRef.orderByChild('email').equalTo(email).once('value');
                
                if (!snapshot.exists()) {
                    Swal.fire('ত্রুটি!', 'ইমেইল বা পাসওয়ার্ড ভুল', 'error');
                    return;
                }
                
                let adminFound = false;
                let adminData = null;
                let adminKey = null;
                
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data.password === password) {
                        adminFound = true;
                        adminData = data;
                        adminKey = child.key;
                    }
                });
                
                if (adminFound) {
                    // Save login state
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminEmail', email);
                    localStorage.setItem('adminRole', adminData.role || 'admin');
                    localStorage.setItem('adminKey', adminKey);
                    
                    // Update UI
                    currentAdminRole = adminData.role || 'admin';
                    updateNavbarUserInfo(email);
                    showMainPanel(email);
                    
                    Swal.fire('সফল!', 'লগইন সফল হয়েছে!', 'success');
                } else {
                    Swal.fire('ত্রুটি!', 'ইমেইল বা পাসওয়ার্ড ভুল', 'error');
                }
                
            } catch (error) {
                console.error("Login error:", error);
                Swal.fire('ত্রুটি!', 'লগইন করতে সমস্যা হয়েছে', 'error');
            }
        });

        // --- ADMIN USERS MANAGEMENT ---
        async function loadAdminUsers() {
            try {
                const snapshot = await adminUsersRef.once('value');
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">কোনো অ্যাডমিন ইউজার নেই</td></tr>';
                    return;
                }
                
                const currentAdminKey = localStorage.getItem('adminKey');
                
                snapshot.forEach(child => {
                    const admin = child.val();
                    const date = admin.createdAt ? new Date(admin.createdAt).toLocaleDateString('bn-BD') : 'N/A';
                    
                    // Don't show delete button for current logged in admin
                    const canDelete = child.key !== currentAdminKey;
                    
                    const row = `
                        <tr>
                            <td>${admin.email}</td>
                            <td>${admin.name || 'N/A'}</td>
                            <td>
                                ${admin.role === 'super_admin' ? 
                                    '<span class="badge bg-danger">সুপার অ্যাডমিন</span>' : 
                                  admin.role === 'admin' ? 
                                    '<span class="badge bg-primary">অ্যাডমিন</span>' : 
                                    '<span class="badge bg-secondary">সাব-অ্যাডমিন</span>'
                                }
                            </td>
                            <td>${date}</td>
                            <td>
                                ${canDelete ? 
                                    `<button class="btn btn-sm btn-danger" onclick="deleteAdminUser('${child.key}')">
                                        <i class="fas fa-trash"></i>
                                    </button>` : 
                                    '<span class="text-muted">বর্তমান ইউজার</span>'
                                }
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading admin users:', error);
                document.getElementById('adminUsersTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-4 text-danger">ডাটা লোড করতে সমস্যা হয়েছে</td></tr>';
            }
        }
        
        function showAddAdminModal() {
            document.getElementById('adminUserModalTitle').textContent = 'নতুন অ্যাডমিন ইউজার';
            document.getElementById('adminUserForm').reset();
            document.getElementById('adminUserId').value = '';
            document.getElementById('adminUserRole').value = 'admin';
            new bootstrap.Modal(document.getElementById('adminUserModal')).show();
        }
        
        async function saveAdminUser() {
            const adminId = document.getElementById('adminUserId').value;
            const email = document.getElementById('adminUserEmail').value.trim();
            const name = document.getElementById('adminUserName').value.trim();
            const password = document.getElementById('adminUserPassword').value;
            const confirmPassword = document.getElementById('adminUserConfirmPassword').value;
            const role = document.getElementById('adminUserRole').value;
            
            // Validation
            if (!email || !name || !password || !confirmPassword) {
                Swal.fire('ত্রুটি!', 'দয়া করে সব ঘর পূরণ করুন', 'error');
                return;
            }
            
            if (password.length < 6) {
                Swal.fire('ত্রুটি!', 'পাসওয়ার্ড কমপক্ষে ৬ ক্যারেক্টারের হতে হবে', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                Swal.fire('ত্রুটি!', 'পাসওয়ার্ড মিলছে না', 'error');
                return;
            }
            
            try {
                // Check if email already exists (for new admin only)
                if (!adminId) {
                    const emailCheck = await adminUsersRef.orderByChild('email').equalTo(email).once('value');
                    if (emailCheck.exists()) {
                        Swal.fire('ত্রুটি!', 'এই ইমেইলটি ইতিমধ্যে ব্যবহৃত হয়েছে', 'error');
                        return;
                    }
                }
                
                const adminData = {
                    email: email,
                    name: name,
                    password: password,
                    role: role,
                    updatedAt: Date.now()
                };
                
                if (adminId) {
                    // Update existing admin
                    await adminUsersRef.child(adminId).update(adminData);
                    Swal.fire('সফল!', 'অ্যাডমিন ইউজার আপডেট করা হয়েছে!', 'success');
                } else {
                    // Create new admin
                    adminData.createdAt = Date.now();
                    await adminUsersRef.push().set(adminData);
                    Swal.fire('সফল!', 'নতুন অ্যাডমিন ইউজার তৈরি করা হয়েছে!', 'success');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('adminUserModal')).hide();
                loadAdminUsers();
                
            } catch (error) {
                console.error('Error saving admin user:', error);
                Swal.fire('ত্রুটি!', 'অ্যাডমিন ইউজার সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }
        
        async function deleteAdminUser(adminId) {
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই অ্যাডমিন ইউজার ডিলিট করতে চান?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                await adminUsersRef.child(adminId).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'অ্যাডমিন ইউজার ডিলিট করা হয়েছে', 'success');
                loadAdminUsers();
            } catch (error) {
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- UTILITY FUNCTIONS ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function showSection(sectionName) {
            // Check permissions based on role
            if (currentAdminRole === 'sub_admin' && sectionName !== 'dashboard') {
                Swal.fire('অনুমতি নেই!', 'সাব-অ্যাডমিন শুধু ড্যাশবোর্ড দেখতে পারবে', 'error');
                return;
            }
            
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('fade-in');
            });
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const selectedSection = document.getElementById(`${sectionName}Section`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                selectedSection.classList.add('fade-in');
            }
            
            const navLink = document.querySelector(`.sidebar .nav-link[onclick="showSection('${sectionName}')"]`);
            if (navLink) {
                navLink.classList.add('active');
            }

            // Detach chat listener if switching away from users section
            if (sectionName !== 'users' && userChatMessagesListener) {
                if (currentChatUserId) {
                    usersRef.child(currentChatUserId).child('supportChats').off('value', userChatMessagesListener);
                }
                currentChatUserId = null;
                userChatMessagesListener = null;
            }

            switch(sectionName) {
                case 'dashboard': loadDashboardStats(); break;
                case 'users': loadUsers(); break;
                case 'deposit-requests': loadRequests('deposits'); break; 
                case 'withdraw-requests': loadRequests('withdrawals'); break; 
                case 'activation-requests': loadRequests('activations'); break; 
                case 'gmail-jobs': loadRequests('gmail_submissions'); break; 
                case 'plans': 
                    loadPlans(); 
                    loadPlansForTasksSelect(); 
                    loadPlanTasks(currentPlanId);
                    break;
                case 'ref-challenges': loadRefChallenges(); break;
                case 'gift-codes': loadGiftCodes(); break; // NEW: Load gift codes
                case 'settings': 
                    loadSettingsData(); 
                    loadContentSettings(); 
                    loadMethods(); 
                    loadSupportLinks(); 
                    loadAppAppearanceSettings(); // NEW: Load app appearance settings
                    loadPopupNoticeSettings(); // NEW: Load popup notice settings
                    break;
                case 'admin-users': loadAdminUsers(); break;
            }
            if (window.innerWidth < 992) toggleSidebar();
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge badge-pending">পেন্ডিং</span>',
                'approved': '<span class="badge badge-approved">অনুমোদিত</span>',
                'rejected': '<span class="badge badge-rejected">প্রত্যাখ্যাত</span>',
                'active': '<span class="badge bg-success">সক্রিয়</span>',
                'inactive': '<span class="badge bg-secondary">নিষ্ক্রিয়</span>',
                'true': '<span class="badge bg-success">সক্রিয়</span>',
                'false': '<span class="badge bg-danger">নিষ্ক্রিয়</span>',
                'expired': '<span class="badge bg-warning text-dark">মেয়াদোত্তীর্ণ</span>', // NEW
                'available': '<span class="badge bg-success">সক্রিয়</span>', // NEW
                'exhausted': '<span class="badge bg-danger">শেষ</span>' // NEW
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function previewImage(url, previewId) {
            const previewDiv = document.getElementById(previewId);
            if (url) {
                previewDiv.innerHTML = `<img src="${url}" class="image-preview" onerror="this.src='https://via.placeholder.com/40'">`;
            } else {
                previewDiv.innerHTML = '';
            }
        }

        function showDecryptedScreenshot(encryptedBase64) {
            const screenshotImage = document.getElementById('screenshotImage');
            screenshotImage.src = ''; 
            screenshotImage.alt = 'Loading Screenshot...'; 

            if (!encryptedBase64 || typeof encryptedBase64 !== 'string') {
                Swal.fire('ত্রুটি!', 'স্ক্রিনশট ডেটা পাওয়া যায়নি বা ভুল ফরম্যাটে আছে।', 'error');
                return;
            }

            try {
                const decryptedBase64 = decryptData(encryptedBase64);
                if (decryptedBase64) {
                    screenshotImage.src = decryptedBase64; 
                    screenshotImage.alt = 'User Screenshot'; 
                    new bootstrap.Modal(document.getElementById('screenshotModal')).show();
                } else {
                    Swal.fire('ত্রুটি!', 'স্ক্রিনশট ডিক্রিপ্ট করা যায়নি। এনক্রিপশন কী মিলেছে কিনা নিশ্চিত করুন অথবা ডেটা ক্ষতিগ্রস্ত হয়েছে।', 'error');
                }
            } catch (e) {
                console.error("Error during decryption and display:", e);
                Swal.fire('ত্রুটি!', 'স্ক্রিনশট ডিক্রিপ্ট করতে সমস্যা হয়েছে।', 'error');
            }
        }

        // --- DASHBOARD FUNCTIONS ---
        async function loadDashboardStats() {
            try {
                const [usersSnap, depositsSnap, withdrawalsSnap, activationsSnap, gmailJobsSnap] = await Promise.all([
                    usersRef.once('value'),
                    depositsRef.orderByChild('status').equalTo('pending').once('value'),
                    withdrawalsRef.orderByChild('status').equalTo('pending').once('value'),
                    activationsRef.orderByChild('status').equalTo('pending').once('value'),
                    gmailSubmissionsRef.orderByChild('status').equalTo('pending').once('value')
                ]);

                // Calculate totals
                let totalBalance = 0;
                let totalWithdraw = 0;
                let totalIncome = 0;
                
                usersSnap.forEach(user => {
                    const userData = user.val();
                    totalBalance += userData.balance || 0;
                    totalWithdraw += userData.totalWithdraw || 0;
                    totalIncome += userData.totalIncome || 0;
                });

                // Update Badges
                document.getElementById('totalUserCount').textContent = usersSnap.numChildren();
                document.getElementById('depositCountBadge').textContent = depositsSnap.numChildren();
                document.getElementById('withdrawCountBadge').textContent = withdrawalsSnap.numChildren();
                document.getElementById('activationCountBadge').textContent = activationsSnap.numChildren();
                document.getElementById('gmailJobCountBadge').textContent = gmailJobsSnap.numChildren();
                
                // Update Dashboard Cards
                document.getElementById('totalUsers').textContent = usersSnap.numChildren();
                document.getElementById('totalPendingDeposits').textContent = depositsSnap.numChildren();
                document.getElementById('totalPendingWithdrawals').textContent = withdrawalsSnap.numChildren();
                document.getElementById('totalPendingActivations').textContent = activationsSnap.numChildren();
                document.getElementById('totalPendingGmailJobs').textContent = gmailJobsSnap.numChildren();
                document.getElementById('totalBalance').textContent = totalBalance.toFixed(2) + ' ৳';
                document.getElementById('totalWithdraw').textContent = totalWithdraw.toFixed(2) + ' ৳';
                document.getElementById('totalIncome').textContent = totalIncome.toFixed(2) + ' ৳';
                
            } catch(e) {
                console.error("Dashboard Load Error:", e);
                Swal.fire('ত্রুটি!', 'ড্যাশবোর্ড ডেটা লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- USER MANAGEMENT FUNCTIONS ---
        async function loadUsers() {
            try {
                const snapshot = await usersRef.once('value');
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">কোনো ব্যবহারকারী নেই</td></tr>';
                    return;
                }
                
                const plansSnap = await plansRef.once('value');
                const plans = plansSnap.val() || {};
                const planNamesMap = {};
                Object.values(plans).forEach(p => planNamesMap[p.name] = p.name);

                snapshot.forEach(user => {
                    const userData = user.val();
                    const planDisplayName = userData.premiumPlan && planNamesMap[userData.premiumPlan] ? userData.premiumPlan : 'ফ্রি';
                    const isActive = userData.isAccountActive ? 'true' : 'false';
                    
                    const row = `
                        <tr>
                            <td>${user.key.substring(0, 8)}...</td>
                            <td>${userData.fullname || userData.username || 'N/A'}</td>
                            <td class="fw-bold">৳ ${userData.balance || 0}</td>
                            <td>${planDisplayName}</td>
                            <td>${getStatusBadge(isActive)}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-info me-1" onclick="openUserChatModal('${user.key}', '${userData.fullname || userData.username || 'N/A'}')" title="চ্যাট">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="editUser('${user.key}')" title="এডিট">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="toggleUserBan('${user.key}', ${userData.isAccountActive})" title="${userData.isAccountActive ? 'ব্যান করুন' : 'আনব্যান করুন'}">
                                    <i class="fas ${userData.isAccountActive ? 'fa-ban' : 'fa-check'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.key}')" title="ডিলিট">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading users:', error);
                Swal.fire('ত্রুটি!', 'ব্যবহারকারী লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function toggleUserBan(userId, currentStatus) {
            const actionText = currentStatus ? 'ব্যান' : 'আনব্যান';
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: `আপনি কি নিশ্চিত এই ইউজারকে ${actionText} করতে চান?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `হ্যাঁ, ${actionText} করুন`,
                cancelButtonText: 'না'
            });

            if (result.isConfirmed) {
                try {
                    await usersRef.child(userId).update({
                        isAccountActive: !currentStatus
                    });
                    Swal.fire('সফল!', `ইউজার সফলভাবে ${actionText} করা হয়েছে।`, 'success');
                    loadUsers();
                } catch (error) {
                    Swal.fire('ত্রুটি!', 'স্ট্যাটাস পরিবর্তন করতে সমস্যা হয়েছে', 'error');
                }
            }
        }

        async function deleteUser(userId) {
            const result = await Swal.fire({
                title: 'সতর্কতা!',
                text: 'আপনি কি নিশ্চিত এই ইউজারকে ডিলিট করতে চান? এটি আর ফিরিয়ে আনা যাবে না!',
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });

            if (result.isConfirmed) {
                try {
                    await usersRef.child(userId).remove();
                    Swal.fire('ডিলিট করা হয়েছে!', 'ইউজার ডাটাবেস থেকে মুছে ফেলা হয়েছে।', 'success');
                    loadUsers();
                    loadDashboardStats();
                } catch (error) {
                    Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
                }
            }
        }

        function searchUsers(query) {
            const rows = document.getElementById('usersTableBody').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(query.toLowerCase())) {
                        found = true;
                        break;
                    }
                }
                rows[i].style.display = found ? '' : 'none';
            }
        }

        async function editUser(userId) {
            try {
                const [userSnap, plansSnap] = await Promise.all([
                    usersRef.child(userId).once('value'),
                    plansRef.once('value')
                ]);
                const userData = userSnap.val();
                const plans = plansSnap.val() || {};
                
                if (userData) {
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editUserName').value = userData.fullname || userData.username || '';
                    document.getElementById('editUserBalance').value = userData.balance || 0;
                    document.getElementById('editUserActiveStatus').value = userData.isAccountActive ? 'true' : 'false';

                    const select = document.getElementById('editUserPlan');
                    select.innerHTML = '<option value="">প্লান নেই (ফ্রি)</option>';
                    Object.entries(plans).forEach(([key, p]) => {
                        const option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = `${p.name} - ৳${p.price}`;
                        if (p.name === userData.premiumPlan) option.selected = true;
                        select.appendChild(option);
                    });

                    const planExpDateInput = document.getElementById('editPlanExpirationDate');
                    if (userData.planExpirationDate) {
                        const date = new Date(userData.planExpirationDate);
                        planExpDateInput.value = date.toISOString().split('T')[0];
                    } else {
                        planExpDateInput.value = '';
                    }
                    
                    new bootstrap.Modal(document.getElementById('editUserModal')).show();
                }
            } catch (error) {
                console.error('Error loading user:', error);
                Swal.fire('ত্রুটি!', 'ব্যবহারকারী লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const userName = document.getElementById('editUserName').value;
            const balance = parseFloat(document.getElementById('editUserBalance').value);
            const planName = document.getElementById('editUserPlan').value || null;
            const isActive = document.getElementById('editUserActiveStatus').value === 'true';
            const planExpirationDateStr = document.getElementById('editPlanExpirationDate').value;
            let planExpirationDate = null;
            if (planExpirationDateStr) {
                planExpirationDate = new Date(planExpirationDateStr).toISOString();
            }

            try {
                await usersRef.child(userId).update({
                    fullname: userName,
                    balance: balance,
                    premiumPlan: planName,
                    isAccountActive: isActive,
                    planExpirationDate: planExpirationDate,
                    updatedAt: Date.now()
                });
                
                Swal.fire('সফল!', 'ব্যবহারকারী আপডেট করা হয়েছে!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                Swal.fire('ত্রুটি!', 'আপডেট করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- REQUEST MANAGEMENT FUNCTIONS ---
        async function loadRequests(type) {
            const ref = {
                'deposits': depositsRef, 
                'withdrawals': withdrawalsRef,
                'activations': activationsRef, 
                'gmail_submissions': gmailSubmissionsRef
            }[type];
            
            const tbodyId = `${type}TableBody`;
            const tbody = document.getElementById(tbodyId);
            
            if (!tbody) {
                console.error(`Table Body not found for ID: ${tbodyId}`);
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">লোডিং...</td></tr>';

            if (!ref) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">ডাটাবেস রেফারেন্স ভুল</td></tr>';
                return;
            }

            try {
                const snapshot = await ref.orderByChild('status').equalTo('pending').once('value');
                const requests = [];
                snapshot.forEach(snap => {
                    const reqData = snap.val();
                    requests.push({ id: snap.key, type: type, transactionId: reqData.transactionId || snap.key, ...reqData }); 
                });

                requests.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                tbody.innerHTML = '';
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">কোনো অনুরোধ নেই</td></tr>'; 
                    return;
                }

                requests.forEach(req => {
                    const date = req.createdAt ? new Date(req.createdAt).toLocaleDateString('bn-BD') : 'N/A';
                    const statusBadge = getStatusBadge(req.status);
                    let rowHtml = '';

                    const imgData = req.screenshotData || req.screenshot || req.screenshotURL || req.screenshotBase64 || req.image || req.proof || '';
                    
                    let screenshotHtml = 'N/A';
                    if (imgData) {
                        screenshotHtml = `<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" 
                                           class="screenshot-preview" alt="Screenshot" 
                                           onclick="showDecryptedScreenshot('${imgData}')">`;
                    }

                    if (type === 'deposits') {
                        rowHtml = `
                            <tr>
                                <td>${req.username || 'N/A'}</td>
                                <td class="fw-bold">৳ ${req.amount || 0}</td>
                                <td>${req.method || 'N/A'}</td>
                                <td>${req.trxId || 'N/A'}</td>
                                <td>${req.senderPhone || 'N/A'}</td>
                                <td>${screenshotHtml}</td>
                                <td>${req.planName || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    ${req.status === 'pending' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="openRequestActionModal('${req.id}', '${type}', '${req.userId}', ${req.amount || 0}, '${req.username || 'N/A'}', '${req.trxId || 'N/A'}', '${req.planName || ''}', '${req.senderPhone || ''}', '${req.transactionId || ''}')">
                                            <i class="fas fa-cog"></i>
                                        </button>` : 
                                        `<span class="badge bg-secondary">${req.status}</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    } else if (type === 'withdrawals') {
                        const fee = req.fee || 0;
                        const netAmount = req.netAmount || req.amount || 0;
                        const feeBadge = fee > 0 ? `<span class="fee-badge ms-1">-${fee}৳</span>` : '';
                        
                        rowHtml = `
                            <tr>
                                <td>${req.username || 'N/A'}</td>
                                <td class="fw-bold">৳ ${req.amount || 0} ${feeBadge}</td>
                                <td class="text-danger">৳ ${fee}</td>
                                <td class="text-success">৳ ${netAmount}</td>
                                <td>${req.method || 'N/A'}</td>
                                <td>${req.number || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    ${req.status === 'pending' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="openRequestActionModal('${req.id}', '${type}', '${req.userId}', ${req.amount || 0}, '${req.username || 'N/A'}', '${req.method || 'N/A'}', '', '', '${req.transactionId || ''}')">
                                            <i class="fas fa-cog"></i>
                                        </button>` : 
                                        `<span class="badge bg-secondary">${req.status}</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    } else if (type === 'activations') {
                        rowHtml = `
                            <tr>
                                <td>${req.username || 'N/A'}</td>
                                <td class="fw-bold">৳ ${req.amount || 0}</td>
                                <td>${req.method || 'N/A'}</td>
                                <td>${req.trxId || 'N/A'}</td>
                                <td>${req.senderPhone || 'N/A'}</td>
                                <td>${screenshotHtml}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    ${req.status === 'pending' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="openRequestActionModal('${req.id}', '${type}', '${req.userId}', ${req.amount || 0}, '${req.username || 'N/A'}', '${req.trxId || 'N/A'}', '', '', '${req.transactionId || ''}')">
                                            <i class="fas fa-cog"></i>
                                        </button>` : 
                                        `<span class="badge bg-secondary">${req.status}</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    } else if (type === 'gmail_submissions') {
                        rowHtml = `
                            <tr>
                                <td>${req.username || 'N/A'}</td>
                                <td>${req.email || 'N/A'}</td>
                                <td class="fw-bold">৳ ${req.price || 0}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    ${req.status === 'pending' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="openRequestActionModal('${req.id}', '${type}', '${req.userId}', ${req.price || 0}, '${req.username || 'N/A'}', '${req.email || 'N/A'}', '', '', '${req.transactionId || ''}')">
                                            <i class="fas fa-cog"></i>
                                        </button>` : 
                                        `<span class="badge bg-secondary">${req.status}</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    }

                    tbody.innerHTML += rowHtml;
                });

            } catch(e) {
                console.error(`Error loading ${type} requests:`, e);
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-danger">ডাটা লোড করতে ব্যর্থ</td></tr>';
            }
        }

        function openRequestActionModal(reqId, type, userId, amount, userName, detail, planName = '', senderPhone = '', transactionId = '') {
            document.getElementById('actionReqId').value = reqId;
            document.getElementById('actionReqType').value = type;
            document.getElementById('actionUserId').value = userId;
            document.getElementById('actionAmount').value = amount;
            document.getElementById('actionPlanName').value = planName;
            document.getElementById('actionTransactionId').value = transactionId; 
            
            let title = '';
            switch(type) {
                case 'deposits': title = 'ডিপোজিট'; break;
                case 'withdrawals': title = 'উইথড্র'; break;
                case 'activations': title = 'একটিভেশন'; break;
                case 'gmail_submissions': title = 'জিমেইল জব'; break;
                default: title = 'অনুরোধ';
            }
            
            document.getElementById('actionModalTitle').textContent = `${title} অনুরোধ প্রক্রিয়া করুন`;
            document.getElementById('actionUserName').textContent = userName;
            document.getElementById('actionAmountDisplay').textContent = `৳ ${amount}`;
            
            let trxDetails = detail; 
            if (type === 'withdrawals') {
                trxDetails = `মেথড: ${detail}`;
            } else if (type === 'gmail_submissions') {
                trxDetails = `ইমেইল: ${detail}`;
            } else if (senderPhone) { 
                trxDetails = `ট্রানজেকশন: ${detail} | সেন্ডার: ${senderPhone}`;
            }
            
            document.getElementById('actionTrxDetails').textContent = trxDetails;
            document.getElementById('actionMessage').value = ''; 
            
            document.getElementById('job-warning').style.display = (type === 'gmail_submissions') ? 'block' : 'none';

            new bootstrap.Modal(document.getElementById('requestActionModal')).show();
        }

        async function processRequest(status) {
            const reqId = document.getElementById('actionReqId').value;
            const type = document.getElementById('actionReqType').value;
            const userId = document.getElementById('actionUserId').value;
            const amount = parseFloat(document.getElementById('actionAmount').value);
            const message = document.getElementById('actionMessage').value;
            const planNameFromRequest = document.getElementById('actionPlanName').value; 
            const transactionId = document.getElementById('actionTransactionId').value; 
            const detailFromModal = document.getElementById('actionTrxDetails').textContent;

            const ref = { 
                'deposits': depositsRef, 
                'withdrawals': withdrawalsRef, 
                'activations': activationsRef, 
                'gmail_submissions': gmailSubmissionsRef
            }[type];

            if (!ref) {
                Swal.fire('ত্রুটি!', 'ভুল অনুরোধের ধরন', 'error');
                return;
            }

            if (status === 'rejected') {
                const result = await Swal.fire({
                    title: 'নিশ্চিত করুন', 
                    text: `আপনি কি নিশ্চিত ${type} অনুরোধটি বাতিল করতে চান?`, 
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonText: 'হ্যাঁ, বাতিল করুন'
                });
                if (!result.isConfirmed) return;
            }

            try {
                // Update request status in its specific collection
                await ref.child(reqId).update({ 
                    status: status, 
                    processedAt: Date.now(), 
                    processedBy: 'admin', 
                    reason: message || (status === 'rejected' ? 'Admin Rejected' : 'Admin Approved') 
                });

                const userSnap = await usersRef.child(userId).once('value');
                const userData = userSnap.val();
                if (!userData) {
                    Swal.fire('সফল!', `অনুরোধ ${status === 'approved' ? 'অনুমোদিত' : 'বাতিল'} হয়েছে, কিন্তু ইউজার খুঁজে পাওয়া যায়নি।`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('requestActionModal')).hide();
                    loadRequests(type);
                    loadDashboardStats();
                    return;
                }

                const updates = {};
                const transactionUpdates = {
                    status: status,
                    date: new Date().toISOString(),
                    details: message || (status === 'rejected' ? 'Admin Rejected' : 'Admin Approved')
                };

                if (status === 'approved') {
                    if (type === 'deposits') {
                        updates.balance = (userData.balance || 0) + amount;
                        updates.totalIncome = (userData.totalIncome || 0) + amount;
                        
                        if (planNameFromRequest) { 
                            const plansData = (await plansRef.orderByChild('name').equalTo(planNameFromRequest).once('value')).val();
                            if (plansData) {
                                const planKey = Object.keys(plansData)[0];
                                const plan = plansData[planKey];
                                updates.premiumPlan = plan.name;
                                const expirationDate = new Date(Date.now() + (plan.validity * 24 * 60 * 60 * 1000)).toISOString();
                                updates.planExpirationDate = expirationDate;
                                updates.pendingPlanName = null; // Clear pending plan name on approval
                                transactionUpdates.planName = plan.name; 
                            }
                        }

                    } else if (type === 'gmail_submissions') {
                        updates.balance = (userData.balance || 0) + amount;
                        updates.totalIncome = (userData.totalIncome || 0) + amount;
                        const emailMatch = detailFromModal.match(/ইমেইল:\s*(.*)/);
                        transactionUpdates.email = emailMatch ? emailMatch[1].trim() : 'N/A'; 

                        const gmailStats = userData.gmailStats || { total: 0, approved: 0, rejected: 0, earned: 0, holding: 0 };
                        updates['gmailStats/approved'] = (gmailStats.approved || 0) + 1;
                        updates['gmailStats/earned'] = (gmailStats.earned || 0) + amount;
                        updates['gmailStats/holding'] = (gmailStats.holding || 0) - amount;

                    } else if (type === 'activations') {
                        updates.isAccountActive = true;
                        updates.pendingActivation = false; 
                        
                        if (!userData.premiumPlan) {
                            const plansSnap = await plansRef.orderByChild('price').equalTo(0).once('value');
                            const freePlan = plansSnap.exists() ? Object.values(plansSnap.val())[0] : null;
                            updates.premiumPlan = freePlan ? freePlan.name : 'Basic';
                            updates.planExpirationDate = freePlan ? new Date(Date.now() + (freePlan.validity * 24 * 60 * 60 * 1000)).toISOString() : null;
                        }
                    } else if (type === 'withdrawals') {
                        const withdrawData = (await ref.child(reqId).once('value')).val();
                        transactionUpdates.method = withdrawData.method; 
                        transactionUpdates.number = withdrawData.number;
                        transactionUpdates.fee = withdrawData.fee || 0;
                        transactionUpdates.netAmount = withdrawData.netAmount || amount;
                        
                        updates.totalWithdraw = (userData.totalWithdraw || 0) + amount;
                    }

                    if (Object.keys(updates).length > 0) {
                        await usersRef.child(userId).update(updates);
                    }
                } else if (status === 'rejected') { 
                    if (type === 'withdrawals') {
                        updates.balance = (userData.balance || 0) + amount; 
                        const withdrawData = (await ref.child(reqId).once('value')).val();
                        transactionUpdates.method = withdrawData.method; 
                        transactionUpdates.number = withdrawData.number;
                    } else if (type === 'deposits') {
                        if (planNameFromRequest) { 
                            updates.pendingPlanName = null; // Clear pending plan name on rejection
                        }
                    } else if (type === 'activations') {
                        updates.pendingActivation = false; 
                    } else if (type === 'gmail_submissions') {
                        const gmailStats = userData.gmailStats || { total: 0, approved: 0, rejected: 0, earned: 0, holding: 0 };
                        updates['gmailStats/rejected'] = (gmailStats.rejected || 0) + 1;
                        updates['gmailStats/holding'] = (gmailStats.holding || 0) - amount; 
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        await usersRef.child(userId).update(updates);
                    }
                }
                
                // Update the existing transaction entry in 'transactions' collection
                if (transactionId) {
                    await transactionsRef.child(transactionId).update(transactionUpdates);
                } else {
                    console.error("No transactionId found for request:", reqId, type);
                }

                Swal.fire('সফল!', `অনুরোধ ${status === 'approved' ? 'অনুমোদিত' : 'বাতিল'} হয়েছে।`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('requestActionModal')).hide();
                loadRequests(type); // Refresh the specific request list to clear the processed item
                loadDashboardStats(); // Update dashboard counts
                
            } catch (error) {
                console.error(`Error processing request ${type}:`, error);
                Swal.fire('ত্রুটি!', 'অনুরোধ প্রক্রিয়া করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- SETTINGS FUNCTIONS ---
        async function loadSettingsData() {
            try {
                const snapshot = await settingsRef.once('value');
                const gmailSnap = await gmailSettingsRef.once('value');
                const settings = snapshot.val() || {};
                const gmailSettings = gmailSnap.val() || {};
                
                // Fees and Limits
                document.getElementById('activationFee').value = (settings.activationFee != null) ? settings.activationFee : 100;
                document.getElementById('minWithdraw').value = settings.minWithdraw || 100;
                document.getElementById('minDeposit').value = settings.minDeposit || 50;
                document.getElementById('referrerBonus').value = settings.referrerBonus || 20;
                document.getElementById('withdrawFee').value = settings.withdrawFee || 5;
                document.getElementById('withdrawReqRefs').value = settings.withdrawReqRefs || 0;

                // Job Settings
                document.getElementById('gmailJobReward').value = gmailSettings.price || 10;
                document.getElementById('gmailPassword').value = gmailSettings.password || 'password123';

                // System Toggles
                document.getElementById('toggleWithdraw').checked = settings.withdrawSystem !== false;
                document.getElementById('toggleDeposit').checked = settings.depositSystem !== false;
                document.getElementById('toggleGmailJob').checked = settings.gmailJobSystem !== false;
                document.getElementById('toggleReferral').checked = settings.referralSystem !== false;
                document.getElementById('dailyLoginBonus').value = settings.dailyLoginBonus || 2;
                
                // Load the new content settings here as well
                loadContentSettings();
                loadAppAppearanceSettings(); // Load app appearance settings
                loadPopupNoticeSettings(); // Load popup notice settings

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // NEW/UPDATED: Function to load content sections
        async function loadContentSettings() {
            try {
                const snapshot = await contentSettingsRef.once('value');
                const contentSettings = snapshot.val() || {};
                
                // Task Wait Time
                document.getElementById('taskWaitTime').value = contentSettings.taskWaitTime || 10;
                
                // Render dynamic sections
                renderContentSections('rules', contentSettings.rulesSections);
                renderContentSections('privacyPolicy', contentSettings.privacyPolicySections);
                
            } catch (error) {
                console.error('Error loading content settings:', error);
            }
        }

        // NEW: Function to render dynamic content sections
        function renderContentSections(page, sections) {
            const containerId = `${page}SectionsContainer`;
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!Array.isArray(sections)) return;

            sections.forEach((section, index) => {
                addContentSection(page, section.type, section.value, index);
            });
        }
        
        // NEW: Function to create and add a single content section
        function addContentSection(page, type, initialValue = '', index = -1) {
            const container = document.getElementById(`${page}SectionsContainer`);
            const div = document.createElement('div');
            div.className = 'content-section-item';
            div.dataset.type = type;

            let labelText = '';
            let inputElement;

            switch (type) {
                case 'title':
                    labelText = 'সেকশন টাইটেল (যেমন: ১. ভূমিকা)';
                    inputElement = `<input type="text" class="form-control form-control-sm content-section-value" value="${initialValue}" placeholder="টাইটেল লিখুন">`;
                    break;
                case 'text':
                    labelText = 'টেক্সট কন্টেন্ট';
                    inputElement = `<textarea class="form-control form-control-sm content-section-value" rows="3" placeholder="কন্টেন্ট লিখুন">${initialValue}</textarea>`;
                    break;
                case 'image':
                    labelText = 'ইমেজ লিংক (URL)';
                    inputElement = `<input type="url" class="form-control form-control-sm content-section-value" value="${initialValue}" placeholder="ইমেজের URL দিন">`;
                    if (initialValue) {
                        inputElement += `<img src="${initialValue}" class="image-preview mt-2" onerror="this.style.display='none'">`;
                    }
                    break;
                case 'video':
                    labelText = 'ভিডিও এমবেড/লিংক (YouTube/অন্যান্য)';
                    inputElement = `<input type="url" class="form-control form-control-sm content-section-value" value="${initialValue}" placeholder="ভিডিওর URL দিন (যেমন: https://www.youtube.com/embed/...)">`;
                    if (initialValue) {
                         inputElement += `<p class="form-text mt-2 text-primary">ভিডিও URL সেট হয়েছে। ইউজার প্যানেলে প্রিভিউ দেখুন।</p>`;
                    }
                    break;
            }

            div.innerHTML = `
                <button type="button" class="btn btn-danger btn-sm content-section-delete" onclick="this.closest('.content-section-item').remove()">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="content-section-header">${labelText} (${type.toUpperCase()})</div>
                <div class="mb-1">
                    ${inputElement}
                </div>
            `;
            
            // Insert at specific index or append
            if (index >= 0 && index < container.children.length) {
                container.insertBefore(div, container.children[index]);
            } else {
                container.appendChild(div);
            }
        }
        
        // UPDATED: Function to save content settings
        async function saveContentSettings() {
            const taskWaitTime = parseInt(document.getElementById('taskWaitTime').value);
            
            if (isNaN(taskWaitTime) || taskWaitTime < 1) {
                Swal.fire('ত্রুটি!', 'টাস্কের অপেক্ষা সময় ১ সেকেন্ডের বেশি হতে হবে।', 'error');
                return;
            }

            // 1. Collect dynamic content sections
            const collectSections = (page) => {
                const container = document.getElementById(`${page}SectionsContainer`);
                const sections = [];
                container.querySelectorAll('.content-section-item').forEach(item => {
                    const type = item.dataset.type;
                    const valueEl = item.querySelector('.content-section-value');
                    const value = valueEl ? valueEl.value.trim() : '';

                    // Only save if the value is not empty
                    if (value) {
                        sections.push({ type: type, value: value });
                    }
                });
                return sections;
            };

            const rulesSections = collectSections('rules');
            const privacyPolicySections = collectSections('privacyPolicy');
            
            if (rulesSections.length === 0) {
                Swal.fire('সতর্কতা!', 'রুলস পেজের জন্য কমপক্ষে একটি সেকশন যোগ করুন।', 'warning');
            }
            if (privacyPolicySections.length === 0) {
                Swal.fire('সতর্কতা!', 'প্রাইভেসি পলিসি পেজের জন্য কমপক্ষে একটি সেকশন যোগ করুন।', 'warning');
            }

            try {
                await contentSettingsRef.update({
                    taskWaitTime: taskWaitTime,
                    rulesSections: rulesSections,
                    privacyPolicySections: privacyPolicySections,
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'কন্টেন্ট ও টাস্ক সেটিংস সেভ করা হয়েছে!', 'success');
                // Reload sections to reflect saved changes
                loadContentSettings();
            } catch (error) {
                console.error("Save content settings error:", error);
                Swal.fire('ত্রুটি!', 'কন্টেন্ট সেটিংস সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        // NEW: App Appearance Settings
        async function loadAppAppearanceSettings() {
            try {
                const snapshot = await settingsRef.once('value');
                const appSettings = snapshot.val() || {};
                
                document.getElementById('appName').value = appSettings.appName || 'Earnix';
                document.getElementById('appLogoURL').value = appSettings.appLogoURL || '';
                previewImage(appSettings.appLogoURL, 'appLogoPreview');
            } catch (error) {
                console.error('Error loading app appearance settings:', error);
            }
        }

        async function saveAppAppearanceSettings() {
            const appName = document.getElementById('appName').value.trim();
            const appLogoURL = document.getElementById('appLogoURL').value.trim();

            if (!appName) {
                Swal.fire('ত্রুটি!', 'অ্যাপের নাম খালি রাখা যাবে না।', 'error');
                return;
            }

            try {
                await settingsRef.update({
                    appName: appName,
                    appLogoURL: appLogoURL,
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'অ্যাপ অ্যাপিয়ারেন্স সেটিংস সেভ করা হয়েছে!', 'success');
                loadAppAppearanceSettings(); // Reload to update preview
            } catch (error) {
                console.error("Save app appearance settings error:", error);
                Swal.fire('ত্রুটি!', 'অ্যাপ অ্যাপিয়ারেন্স সেটিংস সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- REMAINDER OF UNCHANGED FUNCTIONS (saveFeesSettings, saveGmailJobSettings, etc.) ---
        
        async function saveFeesSettings() {
            try {
                await settingsRef.update({
                    activationFee: parseFloat(document.getElementById('activationFee').value),
                    minWithdraw: parseFloat(document.getElementById('minWithdraw').value),
                    minDeposit: parseFloat(document.getElementById('minDeposit').value),
                    referrerBonus: parseFloat(document.getElementById('referrerBonus').value),
                    withdrawFee: parseFloat(document.getElementById('withdrawFee').value),
                    withdrawReqRefs: parseInt(document.getElementById('withdrawReqRefs').value),
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'ফি সেটিংস সেভ করা হয়েছে!', 'success');
            } catch (error) {
                Swal.fire('ত্রুটি!', 'সেটিংস সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }
        
        async function saveGmailJobSettings() {
            try {
                await gmailSettingsRef.update({
                    price: parseFloat(document.getElementById('gmailJobReward').value),
                    password: document.getElementById('gmailPassword').value,
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'জিমেইল জব সেটিংস সেভ করা হয়েছে!', 'success');
            } catch (error) {
                Swal.fire('ত্রুটি!', 'সেটিংস সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function saveSystemToggles() {
            try {
                await settingsRef.update({
                    withdrawSystem: document.getElementById('toggleWithdraw').checked,
                    depositSystem: document.getElementById('toggleDeposit').checked,
                    gmailJobSystem: document.getElementById('toggleGmailJob').checked,
                    referralSystem: document.getElementById('toggleReferral').checked,
                    dailyLoginBonus: parseFloat(document.getElementById('dailyLoginBonus').value),
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'সিস্টেম টগল সেভ করা হয়েছে!', 'success');
            } catch (error) {
                Swal.fire('ত্রুটি!', 'টগল সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }


        async function sendUserNotice() {
            try {
                // This function is for the scrolling notice, not the new popup
                const noticeData = {
                    title: document.getElementById('userNoticeTitle').value || 'Notice',
                    message: document.getElementById('userNotice').value,
                    isActive: true, // Assuming scrolling notice is always active if set
                    id: Date.now() // Simple unique ID
                };
                
                await database.ref('settings/scrollingNotice').set(noticeData); // Renamed node for clarity
                
                Swal.fire('সফল!', 'নোটিশ সফলভাবে পাঠানো হয়েছে! (স্ক্রলিং নোটিশ)', 'success');
            } catch (error) {
                console.error("Scrolling Notice Error:", error);
                Swal.fire('ত্রুটি!', 'নোটিশ পাঠাতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- METHODS MANAGEMENT (Updated for Gateway Link) ---
        async function loadMethods() {
            try {
                const [depositSnap, withdrawSnap] = await Promise.all([
                    depositMethodsRef.once('value'),
                    withdrawMethodsRef.once('value')
                ]);

                const loadList = (snap, listId, isDeposit) => {
                    const list = document.getElementById(listId);
                    list.innerHTML = '';
                    if (!snap.exists()) {
                        list.innerHTML = '<div class="text-center text-muted py-3">কোনো মেথড নেই</div>';
                        return;
                    }
                    Object.entries(snap.val()).forEach(([key, method]) => {
                        list.innerHTML += `
                            <div class="method-item border-left border-primary">
                                <div class="method-info d-flex align-items-center">
                                    <img src="${method.image}" class="method-image me-3" onerror="this.src='https://via.placeholder.com/40'">
                                    <div>
                                        <div class="fw-bold">${method.name}</div>
                                        <small class="text-muted">নাম্বার: ${method.number || 'N/A'}</small>
                                        ${method.gatewayLink ? `<br><small class="text-muted"><a href="${method.gatewayLink}" target="_blank">গেটওয়ে লিংক</a></small>` : ''}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMethod('${key}', '${isDeposit ? 'deposit' : 'withdraw'}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                };

                loadList(depositSnap, 'depositMethodsList', true);
                loadList(withdrawSnap, 'withdrawMethodsList', false);
            } catch (error) {
                console.error("Method load error:", error);
            }
        }

        document.getElementById('addDepositMethodForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('depositMethodName').value;
            const image = document.getElementById('depositMethodImage').value;
            const number = document.getElementById('depositMethodNumber').value;
            const gatewayLink = document.getElementById('depositMethodGatewayLink').value; // NEW
            try {
                await depositMethodsRef.push().set({ name, image, number, gatewayLink, status: 'active', createdAt: Date.now() }); // UPDATED
                Swal.fire('সফল!', 'ডিপোজিট মেথড যোগ করা হয়েছে!', 'success');
                this.reset();
                previewImage('', 'depositPreview');
                loadMethods();
            } catch (error) { 
                Swal.fire('ত্রুটি!', 'মেথড যোগ করতে সমস্যা হয়েছে', 'error'); 
            }
        });

        document.getElementById('addWithdrawMethodForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('withdrawMethodName').value;
            const image = document.getElementById('withdrawMethodImage').value;
            try {
                await withdrawMethodsRef.push().set({ name, image, status: 'active', createdAt: Date.now() });
                Swal.fire('সফল!', 'উইথড্র মেথড যোগ করা হয়েছে!', 'success');
                this.reset();
                previewImage('', 'withdrawPreview');
                loadMethods();
            } catch (error) { 
                Swal.fire('ত্রুটি!', 'মেথড যোগ করতে সমস্যা হয়েছে', 'error'); 
            }
        });
        
        async function deleteMethod(key, type) {
            const result = await Swal.fire({ 
                title: 'নিশ্চিত করুন', 
                text: 'আপনি কি নিশ্চিত এটি ডিলিট করতে চান?', 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন' 
            });
            if (!result.isConfirmed) return;
            const ref = type === 'deposit' ? depositMethodsRef : withdrawMethodsRef;
            try {
                await ref.child(key).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'মেথড ডিলিট করা হয়েছে', 'success');
                loadMethods();
            } catch (error) { 
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error'); 
            }
        }

        // --- SUPPORT LINKS MANAGEMENT (Unchanged) ---
        async function loadSupportLinks() {
            try {
                const snapshot = await supportLinksRef.once('value');
                const list = document.getElementById('supportLinksList');
                list.innerHTML = '';
                if (!snapshot.exists()) {
                    list.innerHTML = '<div class="text-center text-muted py-3">কোনো সাপোর্ট লিংক নেই</div>';
                    return;
                }
                Object.entries(snapshot.val()).forEach(([key, link]) => {
                    list.innerHTML += `
                        <div class="method-item border-left border-primary">
                            <div class="method-info d-flex align-items-center">
                                <i class="${link.icon} me-3 fa-lg text-primary"></i>
                                <div>
                                    <div class="fw-bold">${link.name}</div>
                                    <small class="text-muted"><a href="${link.link}" target="_blank">${link.link}</a></small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary me-1" onclick="editSupportLinkModal('${key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSupportLink('${key}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("Error loading support links:", error);
                document.getElementById('supportLinksList').innerHTML = '<div class="text-center text-danger py-3">লিংক লোড করতে সমস্যা হয়েছে</div>';
            }
        }

        document.getElementById('addSupportLinkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('supportLinkName').value;
            const link = document.getElementById('supportLinkUrl').value;
            const icon = document.getElementById('supportLinkIcon').value;
            try {
                await supportLinksRef.push().set({ name, link, icon, createdAt: Date.now() });
                Swal.fire('সফল!', 'সাপোর্ট লিংক যোগ করা হয়েছে!', 'success');
                this.reset();
                loadSupportLinks();
            } catch (error) { 
                Swal.fire('ত্রুটি!', 'লিংক যোগ করতে সমস্যা হয়েছে', 'error'); 
            }
        });

        async function editSupportLinkModal(key) {
            try {
                const snap = await supportLinksRef.child(key).once('value');
                const linkData = snap.val();
                if (!linkData) return;

                document.getElementById('editSupportLinkId').value = key;
                document.getElementById('editSupportLinkName').value = linkData.name;
                document.getElementById('editSupportLinkUrl').value = linkData.link;
                document.getElementById('editSupportLinkIcon').value = linkData.icon;
                
                new bootstrap.Modal(document.getElementById('editSupportLinkModal')).show();
            } catch (error) {
                console.error('Error loading support link for edit:', error);
                Swal.fire('ত্রুটি!', 'লিংক লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function updateSupportLink() {
            const key = document.getElementById('editSupportLinkId').value;
            const name = document.getElementById('editSupportLinkName').value;
            const link = document.getElementById('editSupportLinkUrl').value;
            const icon = document.getElementById('editSupportLinkIcon').value;

            if (!name || !link || !icon) {
                Swal.fire('ত্রুটি!', 'দয়া করে সব ঘর পূরণ করুন', 'error');
                return;
            }

            try {
                await supportLinksRef.child(key).update({ name, link, icon, updatedAt: Date.now() });
                Swal.fire('সফল!', 'সাপোর্ট লিংক আপডেট করা হয়েছে!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editSupportLinkModal')).hide();
                loadSupportLinks();
            } catch (error) {
                console.error('Error updating support link:', error);
                Swal.fire('ত্রুটি!', 'লিংক আপডেট করতে সমস্যা হয়েছে', 'error');
            }
        }
        
        async function deleteSupportLink(key) {
            const result = await Swal.fire({ 
                title: 'নিশ্চিত করুন', 
                text: 'আপনি কি নিশ্চিত এই সাপোর্ট লিংক ডিলিট করতে চান?', 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন' 
            });
            if (!result.isConfirmed) return;
            try {
                await supportLinksRef.child(key).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'সাপোর্ট লিংক ডিলিট করা হয়েছে', 'success');
                loadSupportLinks();
            } catch (error) { 
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error'); 
            }
        }

        // --- PLANS MANAGEMENT (Updated for plan-specific methods) ---
        async function loadPlans() {
            try {
                const snapshot = await plansRef.once('value');
                const tbody = document.getElementById('plansTableBody');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">কোনো প্লান নেই</td></tr>';
                    return;
                }
                
                Object.entries(snapshot.val()).forEach(([key, p]) => {
                    const row = `
                        <tr>
                            <td>${p.name}</td>
                            <td class="fw-bold">৳ ${p.price || 0}</td>
                            <td>${p.dailyTasks || 0}</td>
                            <td class="fw-bold">৳ ${p.dailyEarning || 0}</td>
                            <td>${getStatusBadge(p.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editPlan('${key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePlan('${key}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        function showAddPlanModal() {
            document.getElementById('planModalTitle').textContent = 'নতুন প্লান তৈরি করুন';
            document.getElementById('planModalSaveBtn').textContent = 'প্লান তৈরি করুন';
            document.getElementById('planForm').reset();
            document.getElementById('planId').value = '';
            currentPlanDepositMethods = {}; // Clear methods for new plan
            renderPlanDepositMethods(); // Render empty list
            new bootstrap.Modal(document.getElementById('planModal')).show();
        }

        async function editPlan(key) {
            const snap = await plansRef.child(key).once('value');
            const p = snap.val();
            if (!p) return;

            document.getElementById('planModalTitle').textContent = 'প্লান এডিট করুন';
            document.getElementById('planModalSaveBtn').textContent = 'সেভ করুন';
            document.getElementById('planId').value = key;
            currentPlanId = key; // Set current plan ID for method management

            document.getElementById('planName').value = p.name;
            document.getElementById('planPrice').value = p.price;
            document.getElementById('planDailyTasks').value = p.dailyTasks;
            document.getElementById('planDailyEarning').value = p.dailyEarning;
            document.getElementById('planValidity').value = p.validity;
            document.getElementById('planStatus').value = p.status;
            
            // Load plan-specific deposit methods
            currentPlanDepositMethods = p.planDepositMethods || {};
            renderPlanDepositMethods();

            new bootstrap.Modal(document.getElementById('planModal')).show();
        }

        async function savePlan() {
            const key = document.getElementById('planId').value;
            const name = document.getElementById('planName').value;
            const price = parseFloat(document.getElementById('planPrice').value);
            const dailyTasks = parseInt(document.getElementById('planDailyTasks').value);
            const dailyEarning = parseFloat(document.getElementById('planDailyEarning').value);
            const validity = parseInt(document.getElementById('planValidity').value);
            const status = document.getElementById('planStatus').value;

            if (!name || isNaN(price) || isNaN(dailyTasks) || isNaN(dailyEarning) || isNaN(validity)) {
                Swal.fire('ত্রুটি!', 'দয়া করে সব ঘর পূরণ করুন', 'error');
                return;
            }

            try {
                const planData = { 
                    name, price, dailyTasks, dailyEarning, validity, status, 
                    planDepositMethods: currentPlanDepositMethods, // Save collected methods
                    updatedAt: Date.now() 
                };
                if (key) {
                    await plansRef.child(key).update(planData);
                } else {
                    await plansRef.push().set({ ...planData, createdAt: Date.now() });
                }
                
                Swal.fire('সফল!', 'প্লান সেভ করা হয়েছে!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
                loadPlans();
                loadPlansForTasksSelect();
            } catch (error) {
                Swal.fire('ত্রুটি!', 'প্লান সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function deletePlan(key) {
            const result = await Swal.fire({ 
                title: 'নিশ্চিত করুন', 
                text: 'এই প্লান ও তার সব টাস্ক ডিলিট হবে!', 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন' 
            });
            if (!result.isConfirmed) return;

            try {
                await plansRef.child(key).remove();
                const tasksSnapshot = await tasksRef.child(key).once('value');
                if (tasksSnapshot.exists()) {
                    await tasksRef.child(key).remove();
                }
                Swal.fire('ডিলিট করা হয়েছে!', 'প্লান ও টাস্ক ডিলিট করা হয়েছে', 'success');
                loadPlans();
                loadPlansForTasksSelect();
                if (currentPlanId === key) {
                    currentPlanId = null;
                    loadPlanTasks(currentPlanId);
                }
            } catch (error) {
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- PLAN DEPOSIT METHODS MANAGEMENT (NEW) ---
        function renderPlanDepositMethods() {
            const listContainer = document.getElementById('planDepositMethodsList');
            listContainer.innerHTML = '';

            if (Object.keys(currentPlanDepositMethods).length === 0) {
                listContainer.innerHTML = '<p class="text-muted small">এই প্লানের জন্য কোনো নির্দিষ্ট ডিপোজিট মেথড সেট করা হয়নি।</p>';
                return;
            }

            Object.entries(currentPlanDepositMethods).forEach(([key, method]) => {
                listContainer.innerHTML += `
                    <div class="plan-method-item">
                        <div class="method-info">
                            <img src="${method.image || 'https://via.placeholder.com/30'}" class="method-image" onerror="this.src='https://via.placeholder.com/30'">
                            <div class="method-details">
                                <div class="fw-bold">${method.name}</div>
                                <small>নাম্বার: ${method.number || 'N/A'}</small>
                                ${method.gatewayLink ? `<br><small><a href="${method.gatewayLink}" target="_blank">গেটওয়ে লিংক</a></small>` : ''}
                            </div>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary me-1" onclick="editPlanDepositMethod('${key}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePlanDepositMethod('${key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function addPlanDepositMethod() {
            document.getElementById('planDepositMethodEditModalTitle').textContent = 'নতুন ডিপোজিট মেথড যোগ করুন';
            document.getElementById('planDepositMethodForm').reset();
            document.getElementById('planDepositMethodKey').value = '';
            previewImage('', 'planDepositMethodPreview');
            new bootstrap.Modal(document.getElementById('planDepositMethodEditModal')).show();
        }

        function editPlanDepositMethod(methodKey) {
            const method = currentPlanDepositMethods[methodKey];
            if (!method) return;

            document.getElementById('planDepositMethodEditModalTitle').textContent = 'ডিপোজিট মেথড এডিট করুন';
            document.getElementById('planDepositMethodKey').value = methodKey;
            document.getElementById('planDepositMethodName').value = method.name;
            document.getElementById('planDepositMethodImage').value = method.image;
            document.getElementById('planDepositMethodNumber').value = method.number;
            document.getElementById('planDepositMethodGatewayLink').value = method.gatewayLink || '';
            previewImage(method.image, 'planDepositMethodPreview');
            new bootstrap.Modal(document.getElementById('planDepositMethodEditModal')).show();
        }

        async function savePlanDepositMethod() {
            const methodKey = document.getElementById('planDepositMethodKey').value;
            const name = document.getElementById('planDepositMethodName').value;
            const image = document.getElementById('planDepositMethodImage').value;
            const number = document.getElementById('planDepositMethodNumber').value;
            const gatewayLink = document.getElementById('planDepositMethodGatewayLink').value;

            if (!name || !image || !number) {
                Swal.fire('ত্রুটি!', 'দয়া করে নাম, ইমেজ লিংক এবং নাম্বার দিন।', 'error');
                return;
            }

            const newMethod = { name, image, number, gatewayLink };
            if (methodKey) {
                currentPlanDepositMethods[methodKey] = newMethod;
            } else {
                const newKey = `method_${Date.now()}`; // Simple unique key
                currentPlanDepositMethods[newKey] = newMethod;
            }
            
            Swal.fire('সফল!', 'মেথড সেভ করা হয়েছে। প্লান সেভ করতে ভুলবেন না।', 'success');
            bootstrap.Modal.getInstance(document.getElementById('planDepositMethodEditModal')).hide();
            renderPlanDepositMethods();
        }

        async function deletePlanDepositMethod(methodKey) {
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই মেথড ডিলিট করতে চান?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });

            if (result.isConfirmed) {
                delete currentPlanDepositMethods[methodKey];
                Swal.fire('ডিলিট করা হয়েছে!', 'মেথড ডিলিট করা হয়েছে। প্লান সেভ করতে ভুলবেন না।', 'success');
                renderPlanDepositMethods();
            }
        }


        async function loadPlansForTasksSelect() {
            try {
                const snapshot = await plansRef.once('value');
                const select = document.getElementById('planForTasks');
                select.innerHTML = '<option value="">প্লান নির্বাচন করুন</option><option value="basic">ফ্রি টাস্ক (Basic)</option>';
                
                if (snapshot.exists()) {
                    Object.entries(snapshot.val()).forEach(([key, p]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${p.name} - ৳${p.price}`;
                        select.appendChild(option);
                    });
                }

                if (currentPlanId && document.querySelector(`#planForTasks option[value="${currentPlanId}"]`)) {
                    select.value = currentPlanId;
                    loadPlanTasks(currentPlanId);
                } else {
                    currentPlanId = null;
                    select.value = '';
                    loadPlanTasks(currentPlanId);
                }

            } catch (error) {
                console.error('Error loading plans for tasks select:', error);
            }
        }

        async function loadPlanTasks(planId) {
            currentPlanId = planId;
            const addTaskBtn = document.getElementById('addTaskBtn');
            const tasksContainer = document.getElementById('planTasksContainer');
            const tbody = document.getElementById('planTasksTableBody');
            
            if (!planId) {
                addTaskBtn.disabled = true;
                tasksContainer.style.display = 'none';
                tbody.innerHTML = '';
                return;
            }
            
            addTaskBtn.disabled = false;
            tasksContainer.style.display = 'block';
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3">লোডিং...</td></tr>';
            
            try {
                let snapshot;
                let targetPath; 

                if (planId === 'basic') {
                    targetPath = tasksRef.child('basic');
                } else {
                    targetPath = tasksRef.child(planId);
                }
                snapshot = await targetPath.once('value');

                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">এই প্লানের জন্য কোনো টাস্ক নেই</td></tr>';
                    return;
                }
                
                const tasksData = snapshot.val();
                
                Object.entries(tasksData).forEach(([key, t]) => {
                    const displayPlanId = planId;
                    const row = `
                        <tr>
                            <td>${t.name}</td>
                            <td class="fw-bold">৳ ${t.reward || 0}</td>
                            <td>${t.dailyLimit || 'N/A'}</td>
                            <td>${getStatusBadge(t.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editTask('${key}', '${displayPlanId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask('${key}', '${displayPlanId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading plan tasks:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">ডাটা লোড করতে ব্যর্থ</td></tr>';
            }
        }

        function showAddTaskToPlanModal() {
            if (!currentPlanId) {
                Swal.fire('ত্রুটি!', 'দয়া করে প্রথমে একটি প্লান নির্বাচন করুন', 'error');
                return;
            }
            document.getElementById('taskModalTitle').textContent = 'নতুন টাস্ক যোগ করুন';
            document.getElementById('taskModalSaveBtn').textContent = 'টাস্ক যোগ করুন';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskPlanId').value = currentPlanId;
            document.getElementById('taskDailyLimit').value = '1'; // Default to 1 (once daily)
            new bootstrap.Modal(document.getElementById('taskModal')).show();
        }

        async function editTask(key, planIdFromTable) {
            let taskData;
            try {
                let targetRef;
                if (planIdFromTable === 'basic') {
                    targetRef = tasksRef.child('basic');
                } else {
                    targetRef = tasksRef.child(planIdFromTable);
                }
                taskData = (await targetRef.child(key).once('value')).val();
                
                if (!taskData) return;

                document.getElementById('taskModalTitle').textContent = 'টাস্ক এডিট করুন';
                document.getElementById('taskModalSaveBtn').textContent = 'সেভ করুন';
                document.getElementById('taskId').value = key;
                document.getElementById('taskPlanId').value = planIdFromTable;
                document.getElementById('taskName').value = taskData.name;
                document.getElementById('taskLink').value = taskData.link;
                document.getElementById('taskReward').value = taskData.reward;
                document.getElementById('taskDailyLimit').value = taskData.dailyLimit;
                document.getElementById('taskStatus').value = taskData.status;
                
                new bootstrap.Modal(document.getElementById('taskModal')).show();
            } catch (error) {
                console.error('Error loading task for edit:', error);
                Swal.fire('ত্রুটি!', 'টাস্ক লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function saveTask() {
            const key = document.getElementById('taskId').value;
            const planId = document.getElementById('taskPlanId').value;
            const name = document.getElementById('taskName').value;
            const link = document.getElementById('taskLink').value;
            const reward = parseFloat(document.getElementById('taskReward').value);
            const dailyLimit = parseInt(document.getElementById('taskDailyLimit').value);
            const status = document.getElementById('taskStatus').value;

            if (!name || !link || isNaN(reward) || isNaN(dailyLimit)) {
                Swal.fire('ত্রুটি!', 'দয়া করে সব ঘর পূরণ করুন', 'error');
                return;
            }
            if (dailyLimit < 0) {
                Swal.fire('ত্রুটি!', 'ডেইলি লিমিট ০ বা তার বেশি হতে হবে।', 'error');
                return;
            }

            try {
                const taskData = { name, link, reward, dailyLimit, status, updatedAt: Date.now(), planId: planId };
                let targetRef;
                if (planId === 'basic') {
                    targetRef = tasksRef.child('basic'); 
                } else {
                    targetRef = tasksRef.child(planId); 
                }

                if (key) {
                    await targetRef.child(key).update(taskData);
                } else {
                    await targetRef.push().set({ ...taskData, createdAt: Date.now() }); 
                }
                
                Swal.fire('সফল!', 'টাস্ক সেভ করা হয়েছে!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadPlanTasks(planId);
            } catch (error) {
                Swal.fire('ত্রুটি!', 'টাস্ক সেভ করতে সমস্যা হয়েছে', 'error');
                console.error("Save task error:", error);
            }
        }

        async function deleteTask(key, planIdFromTable) {
            const result = await Swal.fire({ 
                title: 'নিশ্চিত করুন', 
                text: 'আপনি কি নিশ্চিত এই টাস্ক ডিলিট করতে চান?', 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন' 
            });
            if (!result.isConfirmed) return;

            try {
                let targetRef;
                if (planIdFromTable === 'basic') {
                    targetRef = tasksRef.child('basic');
                } else {
                    targetRef = tasksRef.child(planIdFromTable);
                }
                await targetRef.child(key).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'টাস্ক ডিলিট করা হয়েছে', 'success');
                loadPlanTasks(planIdFromTable);
            } catch (error) {
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
                console.error("Delete task error:", error);
            }
        }

        // --- REFERRAL CHALLENGES MANAGEMENT (Unchanged) ---
        async function loadRefChallenges() {
            try {
                const snapshot = await refChallengesRef.orderByChild('target').once('value');
                const tbody = document.getElementById('refChallengesTableBody');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">কোনো রেফারাল চ্যালেঞ্জ নেই</td></tr>';
                    return;
                }
                
                const challenges = [];
                snapshot.forEach(child => {
                    challenges.push({ id: child.key, ...child.val() });
                });
                
                challenges.sort((a, b) => a.target - b.target);
                
                challenges.forEach(challenge => {
                    const row = `
                        <tr>
                            <td class="fw-bold">${challenge.target} Active Refs</td>
                            <td class="fw-bold text-success">৳ ${challenge.reward}</td>
                            <td>${getStatusBadge(challenge.status || 'active')}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editRefChallenge('${challenge.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRefChallenge('${challenge.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading ref challenges:', error);
                document.getElementById('refChallengesTableBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center py-4 text-danger">চ্যালেঞ্জ লোড করতে সমস্যা হয়েছে</td></tr>';
            }
        }

        function showAddRefChallengeModal() {
            document.getElementById('refChallengeModalTitle').textContent = 'নতুন রেফারাল চ্যালেঞ্জ';
            document.getElementById('refChallengeForm').reset();
            document.getElementById('refChallengeId').value = '';
            document.getElementById('refChallengeStatus').value = 'active';
            new bootstrap.Modal(document.getElementById('refChallengeModal')).show();
        }

        async function editRefChallenge(challengeId) {
            try {
                const snapshot = await refChallengesRef.child(challengeId).once('value');
                const challenge = snapshot.val();
                
                if (!challenge) {
                    Swal.fire('ত্রুটি!', 'চ্যালেঞ্জ পাওয়া যায়নি', 'error');
                    return;
                }
                
                document.getElementById('refChallengeModalTitle').textContent = 'রেফারাল চ্যালেঞ্জ এডিট করুন';
                document.getElementById('refChallengeId').value = challengeId;
                document.getElementById('refChallengeTarget').value = challenge.target;
                document.getElementById('refChallengeReward').value = challenge.reward;
                document.getElementById('refChallengeStatus').value = challenge.status || 'active';
                
                new bootstrap.Modal(document.getElementById('refChallengeModal')).show();
            } catch (error) {
                console.error('Error loading challenge for edit:', error);
                Swal.fire('ত্রুটি!', 'চ্যালেঞ্জ লোড করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function saveRefChallenge() {
            const challengeId = document.getElementById('refChallengeId').value;
            const target = parseInt(document.getElementById('refChallengeTarget').value);
            const reward = parseFloat(document.getElementById('refChallengeReward').value);
            const status = document.getElementById('refChallengeStatus').value;
            
            if (isNaN(target) || target <= 0 || isNaN(reward) || reward <= 0) {
                Swal.fire('ত্রুটি!', 'দয়া করে সঠিক সংখ্যা প্রবেশ করুন', 'error');
                return;
            }
            
            try {
                const challengeData = {
                    target: target,
                    reward: reward,
                    status: status,
                    updatedAt: Date.now()
                };
                
                if (challengeId) {
                    await refChallengesRef.child(challengeId).update(challengeData);
                } else {
                    await refChallengesRef.push().set({
                        ...challengeData,
                        createdAt: Date.now()
                    });
                }
                
                Swal.fire('সফল!', 'রেফারাল চ্যালেঞ্জ সেভ করা হয়েছে!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('refChallengeModal')).hide();
                loadRefChallenges();
            } catch (error) {
                console.error('Error saving ref challenge:', error);
                Swal.fire('ত্রুটি!', 'চ্যালেঞ্জ সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function deleteRefChallenge(challengeId) {
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই রেফারাল চ্যালেঞ্জ ডিলিট করতে চান?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                await refChallengesRef.child(challengeId).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'রেফারাল চ্যালেঞ্জ ডিলিট করা হয়েছে', 'success');
                loadRefChallenges();
            } catch (error) {
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
            }
        }
        
        // --- GIFT CODES MANAGEMENT (NEW) ---
        async function loadGiftCodes() {
            try {
                const snapshot = await giftCodesRef.orderByChild('createdAt').once('value');
                const tbody = document.getElementById('giftCodesTableBody');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">কোনো গিফট কোড নেই</td></tr>';
                    return;
                }
                
                const giftCodes = [];
                snapshot.forEach(child => {
                    giftCodes.push({ id: child.key, ...child.val() });
                });
                
                const now = Date.now();
                giftCodes.forEach(code => {
                    let status = 'available';
                    if (code.currentUsage >= code.maxUsage) {
                        status = 'exhausted';
                    } else if (new Date(code.expiryDate).getTime() < now) {
                        status = 'expired';
                    }
                    code.status = status;

                    const expiryDate = new Date(code.expiryDate).toLocaleDateString('bn-BD');
                    const row = `
                        <tr>
                            <td class="fw-bold">${code.code}</td>
                            <td class="text-success">৳ ${code.amount}</td>
                            <td>${code.currentUsage || 0}</td>
                            <td>${code.maxUsage}</td>
                            <td>${expiryDate}</td>
                            <td>${getStatusBadge(code.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteGiftCode('${code.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading gift codes:', error);
                document.getElementById('giftCodesTableBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center py-4 text-danger">গিফট কোড লোড করতে সমস্যা হয়েছে</td></tr>';
            }
        }

        function showGenerateGiftCodeModal() {
            document.getElementById('giftCodeForm').reset();
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1); // Default expiry to tomorrow
            document.getElementById('giftCodeExpiry').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('giftCodeMaxUsage').value = '1';
            new bootstrap.Modal(document.getElementById('giftCodeModal')).show();
        }

        function generateRandomCode(length = 8) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        async function generateAndSaveGiftCode() {
            let code = document.getElementById('giftCodeCode').value.trim();
            const amount = parseFloat(document.getElementById('giftCodeAmount').value);
            const maxUsage = parseInt(document.getElementById('giftCodeMaxUsage').value);
            const expiryDate = document.getElementById('giftCodeExpiry').value;

            if (!code) {
                code = generateRandomCode(10); // Auto-generate if not provided
            }
            
            if (isNaN(amount) || amount <= 0 || isNaN(maxUsage) || maxUsage <= 0 || !expiryDate) {
                Swal.fire('ত্রুটি!', 'দয়া করে সঠিক তথ্য দিন। পরিমাণ, সর্বোচ্চ ব্যবহার এবং মেয়াদোত্তীর্ণের তারিখ আবশ্যক।', 'error');
                return;
            }

            try {
                // Check if code already exists
                const codeCheck = await giftCodesRef.orderByChild('code').equalTo(code).once('value');
                if (codeCheck.exists()) {
                    Swal.fire('ত্রুটি!', 'এই কোডটি ইতিমধ্যে ব্যবহৃত হয়েছে। অন্য একটি কোড ব্যবহার করুন বা খালি রাখুন।', 'error');
                    return;
                }

                const giftCodeData = {
                    code: code,
                    amount: amount,
                    maxUsage: maxUsage,
                    currentUsage: 0,
                    expiryDate: expiryDate,
                    createdAt: Date.now()
                };
                
                await giftCodesRef.push().set(giftCodeData);
                
                Swal.fire('সফল!', `গিফট কোড "${code}" সফলভাবে তৈরি হয়েছে!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('giftCodeModal')).hide();
                loadGiftCodes();
            } catch (error) {
                console.error('Error generating/saving gift code:', error);
                Swal.fire('ত্রুটি!', 'গিফট কোড তৈরি করতে সমস্যা হয়েছে', 'error');
            }
        }

        async function deleteGiftCode(codeId) {
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই গিফট কোড ডিলিট করতে চান? এটি আর ব্যবহার করা যাবে না।',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                await giftCodesRef.child(codeId).remove();
                Swal.fire('ডিলিট করা হয়েছে!', 'গিফট কোড ডিলিট করা হয়েছে', 'success');
                loadGiftCodes();
            } catch (error) {
                Swal.fire('ত্রুটি!', 'ডিলিট করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- NEW: POPUP NOTICE FUNCTIONS ---
        async function loadPopupNoticeSettings() {
            try {
                const snapshot = await adminPopupRef.once('value');
                const settings = snapshot.val() || {};
                
                document.getElementById('popupNoticeTitle').value = settings.title || '';
                document.getElementById('popupNoticeMessage').value = settings.message || '';
                document.getElementById('popupNoticeImageLink').value = settings.imageLink || '';
                previewImage(settings.imageLink, 'popupNoticeImagePreview');
                document.getElementById('popupNoticeActive').checked = settings.isActive !== false;

                popupNoticeButtons = settings.buttons || [];
                renderPopupNoticeButtons();
                populateSupportLinkDropdown(); // Populate dropdown for adding new buttons

            } catch (error) {
                console.error('Error loading popup notice settings:', error);
            }
        }

        async function populateSupportLinkDropdown() {
            const dropdown = document.getElementById('newPopupButtonLinkSelect');
            dropdown.innerHTML = '<option value="">লিংক নির্বাচন করুন বা টাইপ করুন</option>';

            try {
                const snapshot = await supportLinksRef.once('value');
                if (snapshot.exists()) {
                    Object.entries(snapshot.val()).forEach(([key, link]) => {
                        const option = document.createElement('option');
                        option.value = link.link;
                        option.textContent = link.name;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading support links for popup dropdown:', error);
            }
        }

        function toggleCustomLinkInput() {
            const selectLink = document.getElementById('newPopupButtonLinkSelect');
            const customLinkInput = document.getElementById('newPopupButtonCustomLink');
            
            if (customLinkInput.style.display === 'none') {
                customLinkInput.style.display = 'block';
                selectLink.style.display = 'none';
                selectLink.value = ''; // Clear selection
            } else {
                customLinkInput.style.display = 'none';
                selectLink.style.display = 'block';
                customLinkInput.value = ''; // Clear custom link
            }
        }

        function addPopupNoticeButton() {
            const buttonText = document.getElementById('newPopupButtonText').value.trim();
            const selectedLink = document.getElementById('newPopupButtonLinkSelect').value;
            const customLink = document.getElementById('newPopupButtonCustomLink').value.trim();

            if (!buttonText) {
                Swal.fire('ত্রুটি!', 'বাটনের লেখা খালি রাখা যাবে না।', 'error');
                return;
            }

            let buttonLink = '';
            if (document.getElementById('newPopupButtonCustomLink').style.display === 'block') {
                buttonLink = customLink;
            } else {
                buttonLink = selectedLink;
            }

            if (!buttonLink) {
                Swal.fire('ত্রুটি!', 'বাটনের জন্য একটি লিংক দিন।', 'error');
                return;
            }

            popupNoticeButtons.push({ text: buttonText, link: buttonLink });
            renderPopupNoticeButtons();

            document.getElementById('newPopupButtonText').value = '';
            document.getElementById('newPopupButtonLinkSelect').value = '';
            document.getElementById('newPopupButtonCustomLink').value = '';
        }

        function renderPopupNoticeButtons() {
            const listContainer = document.getElementById('popupNoticeButtonsList');
            listContainer.innerHTML = '';

            if (popupNoticeButtons.length === 0) {
                listContainer.innerHTML = '<p class="text-muted small">কোনো ইনলাইন বাটন যোগ করা হয়নি।</p>';
                return;
            }

            popupNoticeButtons.forEach((button, index) => {
                listContainer.innerHTML += `
                    <div class="popup-button-item">
                        <span>${button.text}</span>
                        <a href="${button.link}" target="_blank">${button.link.substring(0, 30)}${button.link.length > 30 ? '...' : ''}</a>
                        <div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePopupNoticeButton(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function deletePopupNoticeButton(index) {
            Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই বাটনটি ডিলিট করতে চান?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            }).then((result) => {
                if (result.isConfirmed) {
                    popupNoticeButtons.splice(index, 1);
                    renderPopupNoticeButtons();
                    Swal.fire('ডিলিট করা হয়েছে!', 'বাটনটি ডিলিট করা হয়েছে।', 'success');
                }
            });
        }

        async function savePopupNoticeSettings() {
            const title = document.getElementById('popupNoticeTitle').value.trim();
            const message = document.getElementById('popupNoticeMessage').value.trim();
            const imageLink = document.getElementById('popupNoticeImageLink').value.trim();
            const isActive = document.getElementById('popupNoticeActive').checked;

            if (!title || !message) {
                Swal.fire('ত্রুটি!', 'নোটিশ টাইটেল এবং মেসেজ খালি রাখা যাবে না।', 'error');
                return;
            }

            try {
                await adminPopupRef.set({
                    title: title,
                    message: message,
                    imageLink: imageLink,
                    buttons: popupNoticeButtons, // Save the array of buttons
                    isActive: isActive,
                    updatedAt: Date.now()
                });
                Swal.fire('সফল!', 'পপ-আপ নোটিশ সেভ করা হয়েছে!', 'success');
            } catch (error) {
                console.error("Save popup notice error:", error);
                Swal.fire('ত্রুটি!', 'পপ-আপ নোটিশ সেভ করতে সমস্যা হয়েছে', 'error');
            }
        }

        // --- ADMIN CHAT FUNCTIONS (Unchanged) ---
        async function openUserChatModal(userId, userName) {
            currentChatUserId = userId;
            document.getElementById('chatUserNameTitle').textContent = userName;
            const chatMessagesElement = document.getElementById('userChatMessages');
            chatMessagesElement.innerHTML = '<div class="text-center text-muted">মেসেজ লোড হচ্ছে...</div>';

            // Detach previous listener if any
            if (userChatMessagesListener) {
                usersRef.child(currentChatUserId).child('supportChats').off('value', userChatMessagesListener);
            }

            // Attach new real-time listener
            userChatMessagesListener = usersRef.child(currentChatUserId).child('supportChats').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                chatMessagesElement.innerHTML = ''; // Clear for real-time update
                if (!snapshot.exists()) {
                    chatMessagesElement.innerHTML = '<div class="text-center text-muted">কোনো মেসেজ নেই।</div>';
                    return;
                }

                snapshot.forEach(childSnapshot => {
                    const msgKey = childSnapshot.key;
                    const msg = childSnapshot.val();
                    const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleString('bn-BD') : '';
                    
                    const msgElement = document.createElement('div');
                    msgElement.className = `chat-bubble-admin-panel ${msg.sender === 'user' ? 'user-msg' : 'admin-msg'}`;
                    
                    let messageContentHtml = `<span>${msg.text}</span>`;
                    if (msg.sender === 'admin') {
                        // Add delete button only for admin's own messages
                        messageContentHtml += ` <button class="delete-chat-btn" onclick="deleteAdminChatMessage('${currentChatUserId}', '${msgKey}')"><i class="fas fa-trash"></i></button>`;
                    }
                    
                    msgElement.innerHTML = `
                        <div class="chat-text-wrapper">
                            ${messageContentHtml}
                        </div>
                        <span class="chat-timestamp">${timestamp}</span>
                    `;
                    chatMessagesElement.appendChild(msgElement);
                });
                chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight; // Scroll to bottom
            });

            new bootstrap.Modal(document.getElementById('viewUserChatModal')).show();
        }

        async function sendAdminChatMessage() {
            const chatInput = document.getElementById('adminChatMessageInput');
            const messageText = chatInput.value.trim();
            if (messageText === '' || !currentChatUserId) return;

            try {
                await usersRef.child(currentChatUserId).child('supportChats').push({
                    text: messageText,
                    sender: 'admin', // Mark message as sent by admin
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                chatInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error sending admin message:", error);
                Swal.fire('ত্রুটি!', 'মেসেজ পাঠাতে সমস্যা হয়েছে', 'error');
            }
        }

        async function deleteAdminChatMessage(userId, messageId) {
            const result = await Swal.fire({
                title: 'নিশ্চিত করুন',
                text: 'আপনি কি নিশ্চিত এই মেসেজটি ডিলিট করতে চান?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'হ্যাঁ, ডিলিট করুন',
                cancelButtonText: 'বাতিল'
            });

            if (result.isConfirmed) {
                try {
                    // Only allow deleting messages sent by 'admin' for security
                    const messageSnap = await usersRef.child(userId).child('supportChats').child(messageId).once('value');
                    const messageData = messageSnap.val();
                    if (messageData && messageData.sender === 'admin') {
                        await usersRef.child(userId).child('supportChats').child(messageId).remove();
                        Swal.fire('ডিলিট করা হয়েছে!', 'মেসেজ সফলভাবে ডিলিট করা হয়েছে।', 'success');
                    } else {
                        Swal.fire('ত্রুটি!', 'শুধুমাত্র অ্যাডমিন মেসেজ ডিলিট করতে পারবে।', 'error');
                    }
                } catch (error) {
                    console.error("Error deleting chat message:", error);
                    Swal.fire('ত্রুটি!', 'মেসেজ ডিলিট করতে সমস্যা হয়েছে', 'error');
                }
            }
        }

        // --- INITIALIZE THE ADMIN PANEL (Unchanged) ---
        document.addEventListener('DOMContentLoaded', function() {
            // Check login status first
            checkLoginStatus();
            
            // Setup event listeners
            document.getElementById('sendAdminChatMessageBtn').addEventListener('click', sendAdminChatMessage);
            document.getElementById('adminChatMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAdminChatMessage();
                }
            });

            // Clear chat listener when modal is hidden
            document.getElementById('viewUserChatModal').addEventListener('hidden.bs.modal', function () {
                if (currentChatUserId && userChatMessagesListener) {
                    usersRef.child(currentChatUserId).child('supportChats').off('value', userChatMessagesListener);
                }
                currentChatUserId = null;
                userChatMessagesListener = null;
            });
            
            // Setup settings tabs
            const settingsTabElement = document.getElementById('settingsTab');
            if(settingsTabElement) {
                const triggerTabList = [].slice.call(settingsTabElement.querySelectorAll('button'));
                triggerTabList.forEach(function (triggerEl) {
                    const tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function (event) {
                        event.preventDefault();
                        tabTrigger.show();
                        // Load data specifically for the content, app appearance, and popup notice tabs when clicked
                        if(triggerEl.id === 'content-settings-tab') {
                            loadContentSettings();
                        } else if(triggerEl.id === 'app-appearance-tab') {
                            loadAppAppearanceSettings();
                        } else if(triggerEl.id === 'popup-notice-tab') {
                            loadPopupNoticeSettings();
                        }
                    });
                });
            }
        });

    </script>
</body>
</html>
